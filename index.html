<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title></title>

<style>

.modal-box {
  background: white;
  padding: 30px;
  border-radius: 10px;
  width: 300px;
  box-sizing: border-box;
}

  @media (max-width: 600px) {
    #account-menu {
      right: 10px;
      min-width: 160px;
      font-size: 16px;
    }

    #logout-message button {
      font-size: 16px !important;
      padding: 10px;
    }
  }

#account-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ccc;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 9999;
    min-width: 180px;
    padding: 5px 0;
  }

  #account-menu.show {
    display: block !important;
  }

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f4f9;
    margin: 0;
    padding: 40px 0;
    display: flex;
    justify-content: center;      /* center horizontally */
    flex-direction: column;       /* stack sections vertically */
    align-items: center;          /* center horizontally */
}


.container, #log-container, #import-container, #export-options, .edit-form-container {
    background-color: white;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    border-radius: 8px;
    width: 100%;
    max-width: 900px;
    margin: 20px auto;             /* center and space */
    box-sizing: border-box;
    overflow: auto;
}

        #export-options, #import-container {
            text-align: center;
        }


        h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

input[type="text"], input[type="number"], input[type="date"], button, select {

            width: 100%;
            padding: 10px;
            margin: 8px 0;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        button:hover {
            background-color: #45a049;
        }

        #results {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #map {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            flex-shrink: 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .destination {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fefefe;
        }

        .destination label {
            margin-top: 0;
        }

        .destination input {
            margin-bottom: 8px;
        }

        .delete-btn, .move-btn {
            background-color: red;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 5px;
            margin-top: 5px;
        }

        .delete-btn:hover, .move-btn:hover {
            background-color: darkred;
        }

        .move-btn {
            background-color: #ffa500;
        }

        .move-btn:hover {
            background-color: #ff7f00;
        }

        .destination-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        #log-list {
            list-style-type: none;
            padding: 0;
        }

        #log-list li {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #log-list li:last-child {
            border-bottom: none;
        }

        .log-item-details {
            flex-grow: 1;
            margin-right: 10px;
        }

        .log-actions button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
        }

        .log-actions button:hover {
            background-color: #0056b3;
        }

        #log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #organize-by-day {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        .optional-costs {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .optional-costs label {
            font-weight: normal;
        }

        #export-options button {
            margin: 5px 10px;
            padding: 10px 15px;
            font-size: 16px;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #333;
        }

        .edit-btn:hover {
            background-color: #e0a800;
        }

        .save-btn, .cancel-btn {
            background-color: #28a745;
            color: white;
            margin-left: 5px;
        }

        .cancel-btn {
            background-color: #dc3545;
        }

        .edit-form-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }

        .edit-form-container label {
            font-weight: normal;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

.custom-view-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.custom-view-modal {
    background: white;
    padding: 30px;
    border-radius: 10px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0px 8px 20px rgba(0, 0, 0, 0.2);
    font-size: 16px;
    color: #333;
}

.custom-view-modal h3 {
    margin-top: 0;
    font-size: 22px;
    text-align: center;
}

.custom-view-modal p {
    margin: 10px 0;
}

.custom-view-modal button {
    background-color: #dc3545;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    display: block;
    margin: 20px auto 0;
}

.custom-view-modal button:hover {
    background-color: #c82333;
}

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    </head>
<body>

<div id="auth-message" style="
  background-color: #fff3cd;
  color: #856404;
  border: 1px solid #ffeeba;
  border-radius: 6px;
  padding: 15px 20px;
  margin-bottom: 20px;
  text-align: center;
  max-width: 600px;
  margin-left: auto;
  margin-right: auto;
  font-size: 16px;
">
  ðŸš§ To log your route, you need to 
  <a href="#" onclick="showLogin()" style="color: #0d6efd; font-weight: bold; text-decoration: none;">Sign in</a> 
  or 
  <a href="#" onclick="showSignup()" style="color: #0d6efd; font-weight: bold; text-decoration: none;">Create an account</a>.
</div>


<div id="logout-message" style="display: none; margin: 20px auto; max-width: 100%; text-align: center;">
  âœ… Youâ€™re signed in as <span id="username-display"></span>

  <div style="display: flex; justify-content: center; position: relative; margin-top: 10px;">
    <button onclick="toggleMenu()" style="font-size: 24px; padding: 8px 12px;">â˜°</button>

    <div id="account-menu">
  
      <button onclick="closeMenu(); logout()" style="width: 100%; padding: 10px; background: none; border: none; color: black; text-align: left;">Log Out</button>
      <button onclick="closeMenu(); showPasswordModal()" style="width: 100%; padding: 10px; background: none; border: none; color: black; text-align: left;">Change Password</button>
      <button onclick="closeMenu(); showDeleteModal()" style="width: 100%; padding: 10px; background: none; border: none; color: red; text-align: left;">Delete Account</button>
    </div>
  </div>
</div>









<div class="container">
  <div style="text-align: center;">
    <img src="/logo.png" alt="Logo" style="max-width: 250px; margin-bottom: 10px;">
  </div>

	<label for="log-date">Date</label>
	<input type="date" id="log-date" required>


        <label for="start-address">Start Address</label>
        <input type="text" id="start-address" placeholder="Enter start address" required>

        <div id="destinations-container">
            <div class="destination">
                <label for="destination-1">Destination 1</label>
                <input type="text" id="destination-1" placeholder="Enter destination address" required>
                <label for="earnings-1">Earnings for Destination 1</label>
                <input type="number" id="earnings-1" placeholder="Enter earnings for destination" required>
                <div class="destination-actions">
                    <button class="delete-btn" onclick="deleteDestination(this)">Delete</button>
                    <button class="move-btn" onclick="moveDestinationUp(this)">Move Up</button>
                    <button class="move-btn" onclick="moveDestinationDown(this)">Move Down</button>
                </div>
            </div>
</div>

Â  Â  Â  Â  <button onclick="addDestination()">Add Destination</button>
        <label for="end-address">End Address</label>
        <input type="text" id="end-address" placeholder="Enter end address" required>

        <label for="mpg">Miles per Gallon (MPG)</label>
        <input type="number" id="mpg" placeholder="Enter miles per gallon" required>

        <label for="gas-price">Fuel Price per Gallon</label>
        <input type="number" id="gas-price" placeholder="Enter fuel price per gallon" required>

        <label for="hours-worked">Hours Worked (Optional)</label>
        <input type="number" id="hours-worked" placeholder="Enter total hours worked">

        <div class="optional-costs">
            <h3>Optional Daily Costs</h3>
            <label for="maintenance-cost">Vehicle Maintenance Cost (Optional)</label>
            <input type="number" id="maintenance-cost" placeholder="Enter maintenance cost for the day">

            <label for="supplies-cost">Supplies Cost (Optional)</label>
            <input type="number" id="supplies-cost" placeholder="Enter supplies cost for the day">
        </div>
        <button onclick="optimizeRoute()">Optimize Route</button>
        <button onclick="calculateRoute()">Calculate Route</button>
        <button onclick="logResults()">Log Route</button>
	<div id="confirmation-message" style="display: none; color: green; font-weight: bold; margin-top: 10px;"></div>


        <div id="results" class="hidden">
            <p>Total Mileage: <span id="total-mileage"></span> miles</p>
            <p>Total Drive Time: <span id="total-time"></span></p>
            <p>Total Earnings: $<span id="total-earnings"></span></p>
            <p>Fuel Consumption Cost: $<span id="fuel-cost"></span></p>
            <p>Maintenance Cost: $<span id="maintenance-cost-result"></span></p>
            <p>Supplies Cost: $<span id="supplies-cost-result"></span></p>
            <p>Net Profit: $<span id="net-profit"></span></p>
            <p>Net Profit per Hour (including drive time): $<span id="profit-per-hour"></span></p>
        </div>

<div id="map" class="hidden"></div>
<div id="detailed-results" style="margin-top: 20px;"></div>
<div id="mileage-display" style="text-align: center; font-weight: bold; margin-top: 10px;"></div>
<div id="optimized-mileage-display" style="text-align: center; font-weight: bold; margin-top: 10px;"></div>
    </div>

    <div id="log-container">
        <div id="log-header">
            <h2>Log</h2>
            <div>
  <label for="filter-year">Year:</label>
  <select id="filter-year" onchange="filterByDate()">
    <option value="">All</option>
  </select>

  <label for="filter-month" style="margin-left: 10px;">Month:</label>
  <select id="filter-month" onchange="filterByDate()">
    <option value="">All</option>
    <option value="01">January</option>
    <option value="02">February</option>
    <option value="03">March</option>
    <option value="04">April</option>
    <option value="05">May</option>
    <option value="06">June</option>
    <option value="07">July</option>
    <option value="08">August</option>
    <option value="09">September</option>
    <option value="10">October</option>
    <option value="11">November</option>
    <option value="12">December</option>
  </select>
</div>

        </div>
        <ul id="log-list">
        </ul>
    </div>

    <div id="export-options">
        <h3>Export Log</h3>
        <button onclick="exportToCSV()">Export to CSV</button>
        <button onclick="exportToPDF()">Export to PDF</button>
    </div>

    <div id="import-container">
        <h3>Import Log</h3>
        <input type="file" id="import-file" accept=".csv">
        <button onclick="importLog()">Import Log</button>
    </div>

    <div id="overlay" class="hidden"></div>

    <div id="edit-form-container" class="edit-form-container hidden">
        <h3>Edit Log Entry</h3>
        <label for="edit-date">Date</label>
        <input type="text" id="edit-date">

        <label for="edit-start-address">Start Address</label>
        <input type="text" id="edit-start-address">

        <div id="edit-destinations-container">
            </div>
        <button type="button" onclick="addEditDestination()">Add Destination</button>

        <label for="edit-end-address">End Address</label>
        <input type="text" id="edit-end-address">
<button type="button" onclick="recalculateEditMileageAndCosts()">Recalculate Mileage</button>


        <label for="edit-total-earnings">Total Earnings</label>
        <input type="number" id="edit-total-earnings">

        <label for="edit-fuel-cost">Fuel Consumption Cost</label>
        <input type="number" id="edit-fuel-cost">

        <label for="edit-maintenance-cost">Maintenance Cost</label>
        <input type="number" id="edit-maintenance-cost">

        <label for="edit-supplies-cost">Supplies Cost</label>
        <input type="number" id="edit-supplies-cost">

        <label for="edit-total-mileage">Total Mileage</label>
        <input type="number" id="edit-total-mileage">

        <label for="edit-total-time">Total Drive Time</label>
        <input type="text" id="edit-total-time" placeholder="e.g., 1 hour 30 minutes">

        <label for="edit-hours-worked">Hours Worked (Optional)</label>
        <input type="number" id="edit-hours-worked">

        <button type="button" class="save-btn" onclick="saveEditedLogEntry()">Save</button>
        <button type="button" class="cancel-btn" onclick="closeEditForm()">Cancel</button>
        <input type="hidden" id="edit-index">
    </div>

<script>

function saveUserInputsToLocalStorage({ mpg, gasPrice, startAddress, endAddress }) {
  localStorage.setItem('mpg', mpg);
  localStorage.setItem('gasPrice', gasPrice);
  localStorage.setItem('startAddress', startAddress);
  localStorage.setItem('endAddress', endAddress);
}


document.addEventListener('click', function(event) {
  const menu = document.getElementById('account-menu');
  const button = event.target.closest('button');

  const isToggleButton = button && (button.innerText === 'â˜°' || button.onclick === toggleMenu);

  if (menu && !menu.contains(event.target) && !isToggleButton) {
    closeMenu();
  }
});



function closeMenu() {
  const menu = document.getElementById('account-menu');
  if (menu) {
    menu.classList.remove('show');
    menu.style.display = 'none';
  }
}


function closeAuthModal() {
  document.getElementById('auth-modal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', async () => {
  // Set today's date
  const dateInput = document.getElementById('log-date');
  if (dateInput) {
    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;
  }

  // Update login/logout button visibility
  updateAuthUI();

  // Load and display logs
  logEntries = await loadLog();
  displayLog();
  populateYearOptions();

  // Inject Google Maps script
  const script = document.createElement('script');
  script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCHrNRHP9LNGVHi9Srk1Gfcrv-4ee_gUHQ&libraries=places&callback=initMap`;
  script.async = true;
  script.defer = true;
  document.head.appendChild(script);
});




        let map;
        let directionsService;
        let directionsRenderer;
        let autocompleteStart, autocompleteEnd;
        let editingIndex = -1;
	let originalMileage = null;
let logEntries = [];


function showConfirmationMessage(message) {
    const confirmation = document.getElementById('confirmation-message');
    confirmation.textContent = message;
    confirmation.style.display = 'block';
    setTimeout(() => {
        confirmation.style.display = 'none';
    }, 3000);
}


function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10,
                center: { lat: 37.7749, lng: -122.4194 },
                mapTypeControl: false,
                streetViewControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false
            });

            autocompleteStart = new google.maps.places.Autocomplete(document.getElementById("start-address"), { types: ['geocode'] });
            autocompleteEnd = new google.maps.places.Autocomplete(document.getElementById("end-address"), { types: ['geocode'] });
document.getElementById("start-address").addEventListener("change", resetOriginalMileageDisplay);
document.getElementById("end-address").addEventListener("change", resetOriginalMileageDisplay);


            autocompleteStart.addListener("place_changed", function () {
                const place = autocompleteStart.getPlace();
                if (place.geometry) {
                    document.getElementById("end-address").value = document.getElementById("start-address").value;
                } else {
                    document.getElementById("start-address").value = "";
                }
            });

            const savedMpg = localStorage.getItem('mpg');
            const savedGasPrice = localStorage.getItem('gasPrice');
            const savedStartAddress = localStorage.getItem('startAddress');
            const savedEndAddress = localStorage.getItem('endAddress');

            if (savedMpg) document.getElementById('mpg').value = savedMpg;
            if (savedGasPrice) document.getElementById('gas-price').value = savedGasPrice;
            if (savedStartAddress) document.getElementById('start-address').value = savedStartAddress;
            if (savedEndAddress) document.getElementById('end-address').value = savedEndAddress;

            // Initialize autocomplete for the initial destination
            document.querySelectorAll('#destinations-container .destination input[type="text"]').forEach(initAutocompleteDestination);

            displayLog();
            
        }

window.initMap = initMap;


        function initAutocompleteDestination(inputElement) {
            const autocomplete = new google.maps.places.Autocomplete(inputElement, { types:['geocode'] });
        }


async function calculateRoute() {
            const calculationResult = await calculateRouteData(); // Call the data calculation function
            if (calculationResult) {
                updateUI(calculationResult);
		showConfirmationMessage('âœ… Route calculated successfully!');
            }
        }

        async function calculateRouteData() {
            const startAddress = document.getElementById('start-address').value;
            const endAddress = document.getElementById('end-address').value;
            const mpg = parseFloat(document.getElementById('mpg').value);
            const gasPrice = parseFloat(document.getElementById('gas-price').value);
            const hoursWorked = parseFloat(document.getElementById('hours-worked').value) || 0;
            const maintenanceCost = parseFloat(document.getElementById('maintenance-cost').value) || 0;
            const suppliesCost = parseFloat(document.getElementById('supplies-cost').value) || 0;

            saveUserInputsToLocalStorage({ mpg, gasPrice, startAddress, endAddress });

            const destInputs = document.querySelectorAll('input[id^="destination-"]');
            const earningsInputs = document.querySelectorAll('input[id^="earnings-"]');
            const destinations = Array.from(destInputs).map(input => ({
                location: input.value,
                stopover: true
            }));
    const earnings = Array.from(earningsInputs).map(input => parseFloat(input.value) || 0);
    const totalEarnings = earnings.reduce((sum, val) => sum + val, 0);

            const waypoints = destinations;
            const request = {
                origin: startAddress,
                destination: endAddress,
                waypoints: waypoints,
                travelMode: 'DRIVING'
            };

            return new Promise((resolve, reject) => {
                directionsService.route(request, (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                        document.getElementById('map').classList.remove('hidden');

                        let totalMileage = 0;
                        let totalDuration = 0;

                        response.routes[0].legs.forEach(leg => {
                            totalMileage += leg.distance.value / 1609.34;
                            totalDuration += leg.duration.value;
                        });

    const fuelCost = (totalMileage / mpg) * gasPrice;
    const netProfitBeforeOptional = totalEarnings - fuelCost;
    const netProfit = netProfitBeforeOptional - maintenanceCost - suppliesCost;
    const totalHoursSpent = hoursWorked + (totalDuration / 3600);
    const profitPerHour = totalHoursSpent > 0 ? netProfit / totalHoursSpent : 0;

                        resolve({
                            date: document.getElementById('log-date').value || new Date().toISOString().split('T')[0],
                            startTime: startAddress,
                            endTime: endAddress,
                            destinations: destinations.map(d => d.location),
                            earnings: earnings,
                            totalMileage: totalMileage.toFixed(2),
                            totalTime: formatDuration(totalDuration),
        totalEarnings: totalEarnings.toFixed(2),
        fuelCost: fuelCost.toFixed(2),
                            maintenanceCost: maintenanceCost.toFixed(2),
                            suppliesCost: suppliesCost.toFixed(2),
        netProfit: netProfit.toFixed(2),
                            profitPerHour: profitPerHour.toFixed(2),
                            hoursWorked: hoursWorked
                        });
                    } else {
                        alert('Directions request failed due to ' + status);
                        document.getElementById('map').classList.add('hidden');
                        document.getElementById('results').classList.add('hidden');
                        resolve(null);
                    }
                });
            });
        }

function updateUI(data) {
    if (data) {
        document.getElementById('total-mileage').textContent = data.totalMileage;
        document.getElementById('total-time').textContent = data.totalTime;
        document.getElementById('total-earnings').textContent = data.totalEarnings;
        document.getElementById('fuel-cost').textContent = data.fuelCost;
        document.getElementById('maintenance-cost-result').textContent = data.maintenanceCost;
        document.getElementById('supplies-cost-result').textContent = data.suppliesCost;
        document.getElementById('net-profit').textContent = data.netProfit;
        document.getElementById('profit-per-hour').textContent = data.profitPerHour;
        document.getElementById('results').classList.remove('hidden');

        if (originalMileage === null) {
  originalMileage = data.totalMileage;
}
document.getElementById('mileage-display').textContent = "Original Route: " + originalMileage + " miles";


        // âœ… Add the new detailed display below the map
        const detailedResultsHTML = `
            <h3>Route Details</h3>
            <p><strong>Date:</strong> ${data.date}</p>
            <p><strong>Start Address:</strong> ${data.startTime}</p>
            <p><strong>Destinations:</strong><br>${data.destinations.map(d => `- ${d}`).join('<br>')}</p>
            <p><strong>End Address:</strong> ${data.endTime}</p>
            <p><strong>Earnings per Stop:</strong> ${data.earnings.map(e => `$${parseFloat(e).toFixed(2)}`).join(', ')}</p>
            <p><strong>Total Mileage:</strong> ${data.totalMileage} miles</p>
            <p><strong>Total Drive Time:</strong> ${data.totalTime}</p>
            <p><strong>Total Earnings:</strong> $${data.totalEarnings}</p>
            <p><strong>Fuel Cost:</strong> $${data.fuelCost}</p>
            <p><strong>Maintenance:</strong> $${data.maintenanceCost}</p>
            <p><strong>Supplies:</strong> $${data.suppliesCost}</p>
            <p><strong>Hours Worked:</strong> ${data.hoursWorked ?? '0'} hours</p>
            <p><strong>Net Profit:</strong> $${data.netProfit}</p>
            <p><strong>Profit per Hour:</strong> $${data.profitPerHour}</p>
        `;
        document.getElementById('detailed-results').innerHTML = detailedResultsHTML;
    }
}



function resetOriginalMileageDisplay() {
  if (originalMileage === null) return; // Already reset â€” no need to do anything

  originalMileage = null;
  document.getElementById('mileage-display').textContent = "";
  document.getElementById('optimized-mileage-display').textContent = "";
}


async function logResults() {
  const token = localStorage.getItem("token");

  if (!token) {
    alert("âŒ You must sign in to log your route.");
    showLogin(); // show sign-in modal
    return;
  }

  const calculationResult = await calculateRouteData();
  if (calculationResult) {
    logEntry(calculationResult);
displayLog();
populateYearOptions(); // âœ… add this
updateUI(calculationResult);


    showConfirmationMessage('âœ… Route logged successfully!');
  }
}




async function optimizeRoute() {
    if (originalMileage === null) {
        await calculateRoute(); // This ensures we log original mileage before optimizing
    }

    const startAddress = document.getElementById('start-address').value;
    const endAddress = document.getElementById('end-address').value;
    const destInputs = document.querySelectorAll('#destinations-container .destination input[type="text"]');
    const currentDestinations = Array.from(destInputs).map(input => input.value);

    if (currentDestinations.length < 2) {
        alert('Please add at least two destinations to optimize the route.');
        return;
    }


    const waypoints = currentDestinations.map(location => ({ location: location, stopover: true }));
    const request = {
        origin: startAddress,
        destination: endAddress,
        waypoints: waypoints,
        travelMode: 'DRIVING',
        optimizeWaypoints: true
    };

    directionsService.route(request, (response, status) => {
        if (status === 'OK' && response.routes[0].waypoint_order) {
            const optimizedOrder = response.routes[0].waypoint_order;
            const newDestinationsContainer = document.createElement('div');
            newDestinationsContainer.id = 'destinations-container';

            optimizedOrder.forEach((index, i) => {
                const originalDestinationDiv = destInputs[index].closest('.destination');
                const clonedDestinationDiv = originalDestinationDiv.cloneNode(true);

                const destLabel = clonedDestinationDiv.querySelector('label[for^="destination-"]');
                const destInput = clonedDestinationDiv.querySelector('input[id^="destination-"]');
                const earningsLabel = clonedDestinationDiv.querySelector('label[for^="earnings-"]');
                const earningsInput = clonedDestinationDiv.querySelector('input[id^="earnings-"]');
                const newIndex = i + 1;

                if (destLabel) destLabel.setAttribute('for', `destination-${newIndex}`);
                if (destInput) destInput.id = `destination-${newIndex}`;
                if (earningsLabel) earningsLabel.setAttribute('for', `earnings-${newIndex}`);
                if (earningsInput) earningsInput.id = `earnings-${newIndex}`;

                newDestinationsContainer.appendChild(clonedDestinationDiv);
            });

            const oldDestinationsContainer = document.getElementById('destinations-container');
            oldDestinationsContainer.parentNode.replaceChild(newDestinationsContainer, oldDestinationsContainer);

            document.querySelectorAll('#destinations-container .destination input[type="text"]').forEach(initAutocompleteDestination);

            // âœ… Update map and show optimized results (WITHOUT overwriting original)
            directionsRenderer.setDirections(response);

            let optimizedMileage = 0;
            let totalDuration = 0;
            response.routes[0].legs.forEach(leg => {
                optimizedMileage += leg.distance.value / 1609.34;
                totalDuration += leg.duration.value;
            });

            document.getElementById('optimized-mileage-display').textContent = "Optimized Route: " + optimizedMileage.toFixed(2) + " miles";
            document.getElementById('total-time').textContent = formatDuration(totalDuration);

const optimizedData = {
    date: document.getElementById('log-date').value || new Date().toLocaleDateString(),
    startTime: startAddress,
    endTime: endAddress,
    destinations: Array.from(document.querySelectorAll('input[id^="destination-"]')).map(input => input.value),
    earnings: Array.from(document.querySelectorAll('input[id^="earnings-"]')).map(input => parseFloat(input.value) || 0),
    totalMileage: optimizedMileage.toFixed(2),
    totalTime: formatDuration(totalDuration),
    totalEarnings: (Array.from(document.querySelectorAll('input[id^="earnings-"]')).reduce((sum, i) => sum + (parseFloat(i.value) || 0), 0)).toFixed(2),
    fuelCost: ((optimizedMileage / parseFloat(document.getElementById('mpg').value || 1)) * parseFloat(document.getElementById('gas-price').value || 0)).toFixed(2),
    maintenanceCost: parseFloat(document.getElementById('maintenance-cost').value || 0).toFixed(2),
    suppliesCost: parseFloat(document.getElementById('supplies-cost').value || 0).toFixed(2),
    hoursWorked: parseFloat(document.getElementById('hours-worked').value || 0),
    netProfit: '0', // to be calculated next
    profitPerHour: '0.00'
};

// Recalculate net profit and profit per hour
const netProfitBeforeOptional = optimizedData.totalEarnings - optimizedData.fuelCost;
optimizedData.netProfit = (netProfitBeforeOptional - optimizedData.maintenanceCost - optimizedData.suppliesCost).toFixed(2);
const totalHoursSpent = optimizedData.hoursWorked + (totalDuration / 3600);
optimizedData.profitPerHour = totalHoursSpent > 0 ? (optimizedData.netProfit / totalHoursSpent).toFixed(2) : '0.00';

// âœ… Update UI below the map
updateUI(optimizedData);
showConfirmationMessage('âœ… Route optimized successfully!');



        } else if (status === 'OK') {
            // fallback if optimization fails
            directionsRenderer.setDirections(response);
        } else {
            alert('Could not optimize route due to: ' + status);
        }
    });
}


function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            let formattedString = '';
            if (hours > 0) {
                formattedString += `${hours} hour${hours > 1 ? 's' : ''} `;
            }
            if (minutes > 0) {
                formattedString += `${minutes} minute${minutes > 1 ? 's' : ''} `;
            }
            if (hours === 0 && minutes === 0) {
                formattedString += `${remainingSeconds} second${remainingSeconds !== 1 ? 's' : ''}`;
            }
            return formattedString.trim();
        }

        function addDestination() {
            const newDestinationIndex = document.querySelectorAll('#destinations-container .destination').length + 1;
            const container = document.getElementById('destinations-container');
            const newDestinationDiv = document.createElement('div');
            newDestinationDiv.classList.add('destination');
	    newDestinationDiv.innerHTML = `
    <label for="destination-${newDestinationIndex}">Destination ${newDestinationIndex}</label>
    <input type="text" id="destination-${newDestinationIndex}" placeholder="Enter destination address" required>
    <label for="earnings-${newDestinationIndex}">Earnings for Destination ${newDestinationIndex}</label>
    <input type="number" id="earnings-${newDestinationIndex}" placeholder="Enter earnings for destination" required>
    <div class="destination-actions">
        <button class="delete-btn" onclick="deleteDestination(this)">Delete</button>
        <button class="move-btn" onclick="moveDestinationUp(this)">Move Up</button>
        <button class="move-btn" onclick="moveDestinationDown(this)">Move Down</button>
    </div>
`;
            container.appendChild(newDestinationDiv);
    initAutocompleteDestination(newDestinationDiv.querySelector('input[type="text"]'));
    resetOriginalMileageDisplay();
}

function deleteDestination(button) {
    button.closest('.destination').remove();
    resetOriginalMileageDisplay(); // <- Add this line
}


function moveDestinationUp(button) {
    const destinationDiv = button.closest('.destination');
    const prevDiv = destinationDiv.previousElementSibling;
    if (prevDiv) {
        destinationDiv.parentNode.insertBefore(destinationDiv, prevDiv);
        resetOriginalMileageDisplay();
    }
}


function moveDestinationDown(button) {
    const destinationDiv = button.closest('.destination');
    const nextDiv = destinationDiv.nextElementSibling;
    if (nextDiv) {
        destinationDiv.parentNode.insertBefore(nextDiv, destinationDiv);
        resetOriginalMileageDisplay();
    }
}



 function logEntry(data) {
            logEntries.unshift(data);
            saveLog();
        }

async function saveLog() {
  const token = localStorage.getItem("token");

  if (!token) {
    console.error("âŒ No token found. User must be signed in to save.");
    alert("You must be signed in to save your route logs.");
    showLogin(); // Optional: open login modal automatically
    return;
  }

  console.log("â³ Saving to KVâ€¦", logEntries);

  try {
    const response = await fetch("https://logs.gorouteyourself.com/logs", {
  method: "POST",
  headers: { "Content-Type": "application/json", "Authorization": token },
  body: JSON.stringify(logEntries)
});

    if (!response.ok) {
      const text = await response.text();
      console.error("âŒ Failed to save to KV:", response.status, text);
    } else {
      console.log("âœ… Saved to KV");
    }
  } catch (err) {
    console.error("âŒ Error during saveLog:", err);
  }
}




async function loadLog() {
  const response = await fetch("https://logs.gorouteyourself.com/logs", {
    headers: {
      Authorization: localStorage.getItem("token") || ""
    }
  });

  if (!response.ok) {
    console.error("âŒ Failed to load logs:", await response.text());
    return [];
  }

  return await response.json();
}


function displayLog(filterFn = () => true) {
  const logList = document.getElementById('log-list');
  const organizedLog = organizeLogByDay();
  logList.innerHTML = '';

  const sortedDays = Object.keys(organizedLog).sort((a, b) => new Date(b) - new Date(a));
  for (const day of sortedDays) {
    if (organizedLog[day].some(entry => filterFn(entry.date))) {
      const dayHeading = document.createElement('h3');
      dayHeading.textContent = day;
      logList.appendChild(dayHeading);

      const entries = organizedLog[day].slice().sort((a, b) => new Date(b.date) - new Date(a.date));
      for (const entry of entries.filter(e => filterFn(e.date))) {
        if (entry) {
          const index = logEntries.findIndex(e => JSON.stringify(e) === JSON.stringify(entry));
          const listItem = document.createElement('li');
          const destinations = Array.isArray(entry.destinations) ? entry.destinations.join(', ') : '';

          listItem.innerHTML = `
            <div class="log-item-details">
              <strong>Date:</strong> ${entry.date}<br>
              <strong>Start:</strong> ${entry.startTime}<br>
              <strong>Destinations:</strong> ${destinations}<br>
              <strong>End:</strong> ${entry.endTime}<br>
              <strong>Earnings:</strong> $${entry.totalEarnings || 0}<br>
              <strong>Fuel Consumption Cost:</strong> $${entry.fuelCost}<br>
              <strong>Maintenance:</strong> $${entry.maintenanceCost}<br>
              <strong>Supplies:</strong> $${entry.suppliesCost}<br>
              <strong>Net Profit:</strong> $${entry.netProfit || 0}
            </div>
            <div class="log-actions">
              <button class="edit-btn" onclick="openEditForm(${index})">Edit</button>
              <button onclick="viewLogEntry(${index})">View Details</button>
              <button onclick="deleteLogEntry(${index})">Delete</button>
            </div>
          `;
          logList.appendChild(listItem);
        }
      }
    }
  }

  if (logList.innerHTML === '') {
    const emptyMessage = document.createElement('li');
    emptyMessage.textContent = 'No log entries found for selected filter.';
    logList.appendChild(emptyMessage);
  }
}


function viewLogEntry(index) {
    const entry = logEntries[index];
    if (!entry) {
        console.warn("Invalid log entry index:", index);
        return;
    }

    // ðŸ” Remove any existing modal first
    const existingOverlay = document.querySelector('.custom-view-overlay');
    if (existingOverlay) existingOverlay.remove();

    // âœ… Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'custom-view-overlay';

    // âœ… Create modal
    const modal = document.createElement('div');
    modal.className = 'custom-view-modal';

    // ðŸ”§ Sanitize and format content
    const destinations = entry.destinations?.length
        ? entry.destinations.map(d => `- ${d}`).join('<br>')
        : 'None';

    const earnings = Array.isArray(entry.earnings)
        ? entry.earnings.map(e => `$${parseFloat(e).toFixed(2)}`).join(', ')
        : '$0.00';

    modal.innerHTML = `
        <h3>Log Entry Details</h3>
        <p><strong>Date:</strong> ${entry.date}</p>
        <p><strong>Start Address:</strong> ${entry.startTime}</p>
        <p><strong>Destinations:</strong><br>${destinations}</p>
        <p><strong>End Address:</strong> ${entry.endTime}</p>
        <p><strong>Earnings per Stop:</strong> ${earnings}</p>
        <p><strong>Total Mileage:</strong> ${entry.totalMileage} miles</p>
        <p><strong>Total Drive Time:</strong> ${entry.totalTime}</p>
        <p><strong>Total Earnings:</strong> $${entry.totalEarnings}</p>
        <p><strong>Fuel Cost:</strong> $${entry.fuelCost}</p>
        <p><strong>Maintenance:</strong> $${entry.maintenanceCost}</p>
        <p><strong>Supplies:</strong> $${entry.suppliesCost}</p>
	<p><strong>Hours Worked:</strong> ${entry.hoursWorked ?? '0'} hours</p>
        <p><strong>Net Profit:</strong> $${entry.netProfit}</p>
        <p><strong>Profit per Hour:</strong> $${entry.profitPerHour}</p>
        <button onclick="this.closest('.custom-view-overlay').remove()">Close</button>
    `;

    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}


        function deleteLogEntry(index) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                logEntries.splice(index, 1);
                saveLog();
                filterByDate();
            }
        }

        function organizeLogByDay() {
            return logEntries.reduce((acc, entry) => {
                if (!acc[entry.date]) {
                    acc[entry.date] = [];
                }
                acc[entry.date].push(entry);
                return acc;
            }, {});
        }



function populateYearOptions() {
  const yearSelect = document.getElementById('filter-year');
  const years = Array.from(new Set(logEntries.map(e => e.date.split('-')[0])));
console.log("âœ… Extracted years:", years);
  yearSelect.innerHTML = '<option value="">All</option>';
  years.sort((a, b) => b - a).forEach(y => {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    yearSelect.appendChild(opt);
  });
}


function closeEditForm() {
    console.log("closeEditForm function called");
    document.getElementById('edit-form-container').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    editingIndex = -1;
}

function updateEditTotalEarnings() {
    let total = 0;
    const editEarningsInputs = document.querySelectorAll('#edit-destinations-container input[id^="edit-earnings-"]');
    editEarningsInputs.forEach(input => {
        total += parseFloat(input.value) || 0;
    });
    document.getElementById('edit-total-earnings').value = total.toFixed(2);
}

function updateEditFuelCost() {
    const mileage = parseFloat(document.getElementById('edit-total-mileage').value) || 0;
    const mpg = parseFloat(document.getElementById('edit-mpg').value) || 1; // Prevent division by zero
    const gasPrice = parseFloat(document.getElementById('edit-gas-price').value) || 0;
    const fuelCost = (mileage / mpg) * gasPrice;
    document.getElementById('edit-fuel-cost').value = fuelCost.toFixed(2);
}

function recalculateEditMileageAndCosts() {
    const start = document.getElementById('edit-start-address').value.trim();
    const end = document.getElementById('edit-end-address').value.trim();
    const destInputs = document.querySelectorAll('#edit-destinations-container input[id^="edit-destination-"]');

    const destinations = Array.from(destInputs).filter(input => input.value.trim()).map(input => ({
        location: input.value.trim(),
        stopover: true
    }));

    if (!start || !end || destinations.length !== destInputs.length) {
        console.warn("Missing start/end or destination, skipping route calc");
        return;
    }

    const request = {
        origin: start,
        destination: end,
        waypoints: destinations,
        travelMode: 'DRIVING'
    };

    directionsService.route(request, (response, status) => {
        if (status === 'OK') {
            let totalMileage = 0;
            let totalDuration = 0;
            response.routes[0].legs.forEach(leg => {
                totalMileage += leg.distance.value / 1609.34;
                totalDuration += leg.duration.value;
            });

            const mileageInput = document.getElementById('edit-total-mileage');
            const timeInput = document.getElementById('edit-total-time');

            console.log("Updating:", {
                mileageInput,
                timeInput,
                totalMileage: totalMileage.toFixed(2),
                formattedTime: formatDuration(totalDuration)
            });

            if (mileageInput) mileageInput.value = totalMileage.toFixed(2);
            if (timeInput) timeInput.value = formatDuration(totalDuration);

            updateEditFuelCost();
        } else {
            console.error("Mileage error:", status);
        }
    });
}






function moveEditDestinationUp(button) {
    const destinationDiv = button.closest('.destination');
    const prevDiv = destinationDiv.previousElementSibling;
    if (prevDiv) {
        destinationDiv.parentNode.insertBefore(destinationDiv, prevDiv);
        resetOriginalMileageDisplay();
// Delay mileage recalculation until the user selects or finishes editing the address
addressInput.addEventListener('blur', recalculateEditMileageAndCosts);

// If using Google Autocomplete, also respond to a place selection
const autocomplete = new google.maps.places.Autocomplete(addressInput, { types: ['geocode'] });
autocomplete.addListener('place_changed', recalculateEditMileageAndCosts);

    }
}


function moveEditDestinationDown(button) {
    const destinationDiv = button.closest('.destination');
    const nextDiv = destinationDiv.nextElementSibling;
    if (nextDiv) {
        destinationDiv.parentNode.insertBefore(nextDiv, destinationDiv);
        resetOriginalMileageDisplay();
        recalculateEditMileageAndCosts();
    }
}

function addEditDestination() {
    const container = document.getElementById('edit-destinations-container');
    const newIndex = container.querySelectorAll('.destination').length + 1;

    const destDiv = document.createElement('div');
    destDiv.classList.add('destination');
    destDiv.innerHTML = `
        <label for="edit-destination-${newIndex}">Destination ${newIndex}</label>
        <input type="text" id="edit-destination-${newIndex}" placeholder="Enter destination address">
        <label for="edit-earnings-${newIndex}">Earnings ${newIndex}</label>
        <input type="number" id="edit-earnings-${newIndex}" placeholder="Enter earnings">
        <div class="destination-actions">
            <button type="button" class="delete-btn" onclick="deleteEditDestination(this)">Delete</button>
            <button type="button" class="move-btn" onclick="moveEditDestinationUp(this)">Move Up</button>
            <button type="button" class="move-btn" onclick="moveEditDestinationDown(this)">Move Down</button>
        </div>
    `;

    container.appendChild(destDiv);

    const addressInput = destDiv.querySelector(`#edit-destination-${newIndex}`);
    const autocomplete = new google.maps.places.Autocomplete(addressInput, { types: ['geocode'] });

    // âœ… Only trigger recalculation when a valid place is selected
    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (place && place.geometry) {
            recalculateEditMileageAndCosts();
        } else {
        }
    });

    initAutocompleteDestination(addressInput); // optional, if used elsewhere
    const earningsInput = destDiv.querySelector(`#edit-earnings-${newIndex}`);
    earningsInput.addEventListener('change', updateEditTotalEarnings);

    resetOriginalMileageDisplay();
}



function deleteEditDestination(button) {
    const destinationDiv = button.closest('.destination');
    destinationDiv.remove();

    // Reindex the remaining destinations
    const container = document.getElementById('edit-destinations-container');
    const destinationDivs = container.querySelectorAll('.destination');
    destinationDivs.forEach((div, index) => {
        const newIndex = index + 1;

        // Update labels and IDs for destination
        const destLabel = div.querySelector('label[for^="edit-destination-"]');
        const destInput = div.querySelector('input[id^="edit-destination-"]');
        const earningsLabel = div.querySelector('label[for^="edit-earnings-"]');
        const earningsInput = div.querySelector('input[id^="edit-earnings-"]');

        if (destLabel) destLabel.setAttribute('for', `edit-destination-${newIndex}`);
        if (destInput) {
            destInput.id = `edit-destination-${newIndex}`;
            destInput.placeholder = `Enter destination address`;
        }

        if (earningsLabel) earningsLabel.setAttribute('for', `edit-earnings-${newIndex}`);
        if (earningsInput) {
            earningsInput.id = `edit-earnings-${newIndex}`;
            earningsInput.placeholder = `Enter earnings`;
        }
    });

    updateEditTotalEarnings(); // Recalculate earnings after deletion
    resetOriginalMileageDisplay();
    recalculateEditMileageAndCosts(); // Recalculate mileage and costs
}




function openEditForm(index) {
    editingIndex = index;
    const entry = logEntries[index];
    if (entry) {
        const editFormContainer = document.getElementById('edit-form-container');
        editFormContainer.innerHTML = '';

        // Create and append the basic structure
        editFormContainer.innerHTML = `
            <h3>Edit Log Entry</h3>
            <label for="edit-date">Date</label>
            <input type="date" id="edit-date">

            <label for="edit-start-address">Start Address</label>
            <input type="text" id="edit-start-address">

            <div id="edit-destinations-container"></div>
            <button type="button" onclick="addEditDestination()">Add Destination</button>

            <label for="edit-end-address">End Address</label>
            <input type="text" id="edit-end-address">
<button type="button" onclick="recalculateEditMileageAndCosts()">Recalculate Mileage</button>


            <label for="edit-total-earnings">Total Earnings</label>
            <input type="number" id="edit-total-earnings">

            <label for="edit-maintenance-cost">Maintenance Cost</label>
            <input type="number" id="edit-maintenance-cost">

            <label for="edit-supplies-cost">Supplies Cost</label>
            <input type="number" id="edit-supplies-cost">

            <label for="edit-total-mileage">Total Mileage</label>
            <input type="number" id="edit-total-mileage">

            <label for="edit-total-time">Total Drive Time</label>
            <input type="text" id="edit-total-time" placeholder="e.g., 1 hour 30 minutes">

            <label for="edit-hours-worked">Hours Worked (Optional)</label>
            <input type="number" id="edit-hours-worked">

            <label for="edit-mpg">Miles per Gallon (MPG)</label>
            <input type="number" id="edit-mpg">

            <label for="edit-gas-price">Fuel Price per Gallon</label>
            <input type="number" id="edit-gas-price">

            <label for="edit-fuel-cost">Fuel Consumption Cost</label>
            <input type="number" id="edit-fuel-cost">

            <button type="button" class="save-btn" onclick="saveEditedLogEntry()">Save</button>
            <button type="button" class="cancel-btn" onclick="closeEditForm()">Cancel</button>
            <input type="hidden" id="edit-index">
        `;

        // Populate the fields
        document.getElementById('edit-date').value = entry.date;
        document.getElementById('edit-start-address').value = entry.startTime;
        document.getElementById('edit-end-address').value = entry.endTime;
        document.getElementById('edit-total-earnings').value = String(entry.totalEarnings || 0);
        document.getElementById('edit-fuel-cost').value = String(entry.fuelCost);
        document.getElementById('edit-maintenance-cost').value = entry.maintenanceCost ?? '';
	document.getElementById('edit-supplies-cost').value = entry.suppliesCost ?? '';
        document.getElementById('edit-total-mileage').value = String(entry.totalMileage);
        document.getElementById('edit-total-time').value = entry.totalTime;
        document.getElementById('edit-hours-worked').value = entry.hoursWorked ?? '';
        document.getElementById('edit-mpg').value = String(entry.mpg || localStorage.getItem('mpg') || 0);
        document.getElementById('edit-gas-price').value = String(entry.gasPrice || localStorage.getItem('gasPrice') || 0);

        // Populate destinations
        const editDestinationsContainer = document.getElementById('edit-destinations-container');
        editDestinationsContainer.innerHTML = '';
        entry.destinations.forEach((dest, i) => {
            const earningValue = isNaN(entry.earnings[i]) ? '' : String(entry.earnings[i]);
            const destDiv = document.createElement('div');
            destDiv.classList.add('destination');
destDiv.innerHTML = `
    <label for="edit-destination-${i + 1}">Destination ${i + 1}</label>
    <input type="text" id="edit-destination-${i + 1}" value="${String(dest)}">
    <label for="edit-earnings-${i + 1}">Earnings ${i + 1}</label>
    <input type="number" id="edit-earnings-${i + 1}" value="${earningValue}">
    <div class="destination-actions">
        <button type="button" class="delete-btn" onclick="deleteEditDestination(this)">Delete</button>
        <button type="button" class="move-btn" onclick="moveEditDestinationUp(this)">Move Up</button>
        <button type="button" class="move-btn" onclick="moveEditDestinationDown(this)">Move Down</button>
    </div>
`;

            editDestinationsContainer.appendChild(destDiv);

            const editEarningsInput = destDiv.querySelector(`#edit-earnings-${i + 1}`);
            editEarningsInput.addEventListener('change', updateEditTotalEarnings);
        });

        // Add event listeners for mpg, gas price, and mileage changes
        document.getElementById('edit-mpg').addEventListener('change', updateEditFuelCost);
        document.getElementById('edit-gas-price').addEventListener('change', updateEditFuelCost);
        document.getElementById('edit-total-mileage').addEventListener('change', updateEditFuelCost);

        updateEditFuelCost();
        updateEditTotalEarnings();


setTimeout(() => {
    document.querySelectorAll('#edit-destinations-container input[id^="edit-destination-"]').forEach(input => {
        const autocomplete = new google.maps.places.Autocomplete(input, { types: ['geocode'] });

        // Optional, safe to keep
        initAutocompleteDestination(input);

        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (place && place.geometry) {
                recalculateEditMileageAndCosts();
            } else {
                console.warn("Invalid place selected for destination.");
            }
        });
    });
}, 0);


        document.getElementById('edit-form-container').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';

    } else {
        console.error("Error: No log entry found at index:", index);
    }
}

function saveEditedLogEntry() {
    if (editingIndex === -1) {
        console.warn("No entry selected for editing.");
        return;
    }

    const entry = logEntries[editingIndex];
    entry.date = document.getElementById('edit-date').value;
    entry.startTime = document.getElementById('edit-start-address').value;
    entry.endTime = document.getElementById('edit-end-address').value;

    // âœ… Grab destinations and earnings
    entry.destinations = [];
    entry.earnings = [];

    const destInputs = document.querySelectorAll('#edit-destinations-container input[id^="edit-destination-"]');
    const earningsInputs = document.querySelectorAll('#edit-destinations-container input[id^="edit-earnings-"]');

    destInputs.forEach(input => {
        entry.destinations.push(input.value.trim());
    });

    earningsInputs.forEach(input => {
        const value = parseFloat(input.value.trim()) || 0;
        entry.earnings.push(value);
    });

    // âœ… Recalculate total earnings
    entry.totalEarnings = entry.earnings.reduce((sum, val) => sum + val, 0).toFixed(2);

    entry.fuelCost = parseFloat(document.getElementById('edit-fuel-cost').value);
    entry.maintenanceCost = parseFloat(document.getElementById('edit-maintenance-cost').value);
    entry.suppliesCost = parseFloat(document.getElementById('edit-supplies-cost').value);
    entry.totalMileage = parseFloat(document.getElementById('edit-total-mileage').value);
    entry.totalTime = document.getElementById('edit-total-time').value;
    entry.hoursWorked = parseFloat(document.getElementById('edit-hours-worked').value) || 0;

    entry.mpg = parseFloat(document.getElementById('edit-mpg').value);
    entry.gasPrice = parseFloat(document.getElementById('edit-gas-price').value);

    const netProfitBeforeOptional = entry.totalEarnings - entry.fuelCost;
    entry.netProfit = (netProfitBeforeOptional - entry.maintenanceCost - entry.suppliesCost).toFixed(2);

    // Calculate profit per hour
    let driveTimeInHours = 0;
    const timeMatch = entry.totalTime.match(/(\d+)\s*hour(s)?\s*(\d+)?\s*minute(s)?/i);
    if (timeMatch) {
        const hours = parseInt(timeMatch[1]) || 0;
        const minutes = parseInt(timeMatch[3]) || 0;
        driveTimeInHours = hours + (minutes / 60);
    } else {
        const minuteMatch = entry.totalTime.match(/(\d+)\s*minute(s)?/i);
        if (minuteMatch) {
            driveTimeInHours = parseInt(minuteMatch[1]) / 60;
        }
    }

    const totalHoursSpent = entry.hoursWorked + driveTimeInHours;
    entry.profitPerHour = totalHoursSpent > 0 ? (entry.netProfit / totalHoursSpent).toFixed(2) : '0.00';

    saveLog();
    filterByDate();
    closeEditForm();
}




function exportToCSV() {
    const header = "Date,Start Address,Destinations,End Address,Total Earnings,Fuel Consumption Cost,Maintenance Cost,Supplies Cost,Net Profit,Total Mileage,Total Drive Time,Earnings per Stop,Profit per Hour\n";
    const csvRows = logEntries.map(entry => {
        const formattedDate = entry.date; // Keep the original date format for CSV

        const destinationsString = `"${entry.destinations.map(d => d.replace(/"/g, '""')).join(';')}"`;
        const earningsString = `"${entry.earnings.join(';')}"`;
        const totalTimeString = `"${entry.totalTime.replace(/"/g, '""')}"`;
        const startAddressString = `"${entry.startTime.replace(/"/g, '""')}"`;
        const endAddressString = `"${entry.endTime.replace(/"/g, '""')}"`;
        const profitPerHourString = entry.profitPerHour ? `"${entry.profitPerHour}"` : "";

        return [
            formattedDate,
            startAddressString,
            destinationsString,
            endAddressString,
            entry.totalEarnings,
            entry.fuelCost,
            entry.maintenanceCost,
            entry.suppliesCost,
            entry.netProfit,
            entry.totalMileage,
            totalTimeString,
            earningsString,
            profitPerHourString
        ].join(',');
    });
    const csvString = header + csvRows.join('\n');

    const filename = 'profit_log.csv';
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
    }
}

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const columns = ["Date", "Start", "Destinations", "End", "Earnings", "Fuel", "Maintenance", "Supplies", "Net Profit", "Mileage", "Drive Time"];
            const data = logEntries.map(entry => [
                entry.date,
                entry.startTime,
                entry.destinations.join('\n'),
                entry.endTime,
                `$${entry.totalEarnings}`,
                `$${entry.fuelCost}`,
                `$${entry.maintenanceCost}`,
                `$${entry.suppliesCost}`,
                `$${entry.netProfit}`,
                `${entry.totalMileage} mi`,
                entry.totalTime
            ]);

            pdf.autoTable({
                head: [columns],
                body: data,
                margin: { top: 20, left: 10, right: 10, bottom: 20 },
                headStyles: { fillColor: [44, 62, 80], textColor: [255, 255, 255] },
                columnStyles: { 2: { columnWidth: 30 } }, // Adjust column width for destinations
                didDrawPage: function(data) {
                    pdf.setFontSize(12);
                    pdf.setTextColor(40);
                    pdf.text(`Profit Log - Page ${data.pageNumber}`, data.settings.margin.left, pdf.internal.pageSize.height - 10);
                }
            });

            pdf.save('profit_log.pdf');
        }

function importLog() {
    const token = localStorage.getItem("token");

    if (!token) {
        alert("âŒ You must be signed in to import a CSV file.");
        showLogin(); // Optional: show login modal
        return;
    }

    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const csvData = e.target.result;
            const lines = csvData.split('\n').slice(1); // Skip the header row
            const newLogEntries = [];

            lines.forEach(line => {
                if (line) {
                    const values = line.match(/("([^"]*)"|[^,]+)/g);
                    console.log("CSV Line Values (Regex Split):", values);

                    if (values && values.length === 13) { // Expecting 13 columns now
                        try {
                            const startTime = values[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const endTime = values[3].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const destinationsString = values[2];
                            const earningsString = values[11];
                            const totalTimeString = values[10].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const profitPerHourString = values[12].replace(/^"|"$/g, '');
                            const profitPerHour = parseFloat(profitPerHourString) || 0; // Parse or default to 0

                            const destinations = destinationsString.startsWith('"') && destinationsString.endsWith('"')
                                ? destinationsString.slice(1, -1).split(';').map(d => d.replace(/""/g, '"'))
                                : [destinationsString.replace(/^"|"$/g, '')]; // Clean up single destination

                            const earnings = earningsString.startsWith('"') && earningsString.endsWith('"')
                                ? earningsString.slice(1, -1).split(';').map(parseFloat)
                                : [parseFloat(earningsString.replace(/^"|"$/g, ''))]; // Clean up single earning

                            newLogEntries.push({
                                date: values[0],
                                startTime: startTime,
                                destinations: destinations,
                                endTime: endTime,
                                totalEarnings: parseFloat(values[4]),
                                fuelCost: parseFloat(values[5]),
                                maintenanceCost: parseFloat(values[6]),
                                suppliesCost: parseFloat(values[7]),
                                netProfit: parseFloat(values[8]),
                                totalMileage: parseFloat(values[9]),
                                totalTime: totalTimeString.replace(/:/g, ' hours ').replace(/:/g, ' minutes ').replace(/ seconds$/, '').trim(),
                                earnings: earnings,
                                profitPerHour: profitPerHour
                            });
                        } catch (error) {
                            console.error("Error parsing CSV line:", line, error);
                        }
                    } else {
                        console.warn("Skipping invalid CSV line (wrong number of columns):", line, values ? values.length : 0);
                    }
                }
            });

            logEntries = [...logEntries, ...newLogEntries];
            saveLog();
            filterByDate();
            populateYearOptions();
            alert('Log imported successfully!');
        };

        reader.onerror = function() {
            alert('Error reading the file.');
        };

        reader.readAsText(file);
    } else {
        alert('Please select a CSV file to import.');
    }
}


let isSignup = false;

function showLogin() {
  isSignup = false;
  document.getElementById('auth-title').textContent = 'Sign In';
  document.getElementById('auth-switch-label').textContent = 'Sign Up';
  document.getElementById('auth-modal').style.display = 'flex';
}

function showSignup() {
  isSignup = true;
  document.getElementById('auth-title').textContent = 'Create Account';
  document.getElementById('auth-switch-label').textContent = 'Sign In';
  document.getElementById('auth-modal').style.display = 'flex';
}

function toggleAuthMode() {
  isSignup = !isSignup;
  if (isSignup) {
    showSignup();
  } else {
    showLogin();
  }
}


async function submitAuth() {
  const username = document.getElementById('auth-username').value.trim();
  const password = document.getElementById('auth-password').value.trim();

  if (!username || !password) {
    alert("Username and password required.");
    return;
  }

const endpoint = isSignup
  ? "https://logs.gorouteyourself.com/api/signup"
  : "https://logs.gorouteyourself.com/api/login";


  const res = await fetch(endpoint, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

if (res.ok) {
  const data = await res.json();
  localStorage.setItem("username", username);
  localStorage.setItem("token", data.token);
  document.getElementById('auth-modal').style.display = 'none';
  showConfirmationMessage(`âœ… ${isSignup ? 'Account created' : 'Signed in'} successfully!`);
  updateAuthUI();

  // âœ… Show reset key if this was a signup
  if (isSignup && data.resetKey) {
    alert(`ðŸ” Your reset key is:\n\n${data.resetKey}\n\nSave this key somewhere safe. You'll need it to reset your password.`);
  }

  // âœ… THEN reload the page after user has seen the key
  location.reload();

loadLog();
  } else {
    alert("âŒ " + (await res.text()));
  }
}

function updateAuthUI() {
  const token = localStorage.getItem("token");
  const username = localStorage.getItem("username");

  if (token && username) {
    document.getElementById("auth-message").style.display = "none";
    document.getElementById("logout-message").style.display = "block";
    document.getElementById("username-display").textContent = username;
  } else {
    document.getElementById("auth-message").style.display = "block";
    document.getElementById("logout-message").style.display = "none";
  }
}

function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("username");
  showConfirmationMessage("ðŸ‘‹ Logged out successfully.");
  location.reload(); // âœ… this clears state and reinitializes
}

function showPasswordModal() {
  document.getElementById('change-password-modal').style.display = 'flex';
}

function closePasswordModal() {
  document.getElementById('change-password-modal').style.display = 'none';
}

async function submitPasswordChange() {
  const current = document.getElementById("current-password").value.trim();
  const next = document.getElementById("new-password").value.trim();
  const confirm = document.getElementById("confirm-password").value.trim();

  if (!current || !next || !confirm) return alert("Please fill out all fields.");
  if (next !== confirm) return alert("New passwords do not match.");

  const token = localStorage.getItem("token");
  const username = localStorage.getItem("username");

  if (!token || !username) return alert("You must be signed in.");

  const res = await fetch("https://logs.gorouteyourself.com/api/change-password", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: token },
    body: JSON.stringify({ username, currentPassword: current, newPassword: next })
  });

  if (res.ok) {
    alert("âœ… Password changed successfully.");
    closePasswordModal();
  } else {
    const msg = await res.text();
    alert("âŒ " + msg);
  }
}

function showResetModal() {
  document.getElementById('reset-password-modal').style.display = 'flex';
}

function closeResetModal() {
  document.getElementById('reset-password-modal').style.display = 'none';
}

async function submitResetPassword() {
  const username = document.getElementById('reset-username').value.trim();
  const resetKey = document.getElementById('reset-key').value.trim();
  const newPassword = document.getElementById('reset-new-password').value.trim();

  if (!username || !resetKey || !newPassword) {
    alert("Please fill out all fields.");
    return;
  }

  const res = await fetch("https://logs.gorouteyourself.com/api/reset-password", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, resetKey, newPassword })
  });

  if (res.ok) {
    alert("âœ… Password reset successfully. You can now sign in.");
    closeResetModal();
  } else {
    const msg = await res.text();
    alert("âŒ " + msg);
  }
}

function showDeleteModal() {
  document.getElementById('delete-account-modal').style.display = 'flex';
}

function closeDeleteModal() {
  document.getElementById('delete-account-modal').style.display = 'none';
}

async function submitDeleteAccount() {
  const password = document.getElementById('delete-password').value.trim();
  const username = localStorage.getItem("username");
  const token = localStorage.getItem("token");

  if (!username || !token || !password) {
    alert("Missing credentials.");
    return;
  }

  const res = await fetch("https://logs.gorouteyourself.com/api/delete-account", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: token
    },
    body: JSON.stringify({ username, password })
  });

  if (res.ok) {
    alert("âœ… Your account has been deleted.");
    localStorage.removeItem("username");
    localStorage.removeItem("token");
    location.reload();
  } else {
    const msg = await res.text();
    alert("âŒ " + msg);
  }
}

window.toggleMenu = function () {
  console.log("toggleMenu() triggered!");

  const menu = document.getElementById('account-menu');
  if (!menu) return console.warn('Menu not found');

  menu.classList.toggle("show");
};

function filterByDate() {
  const year = document.getElementById('filter-year').value;
  const month = document.getElementById('filter-month').value;

  displayLog((entryDate) => {
    const [yyyy, mm] = entryDate.split('-');
    const matchesYear = !year || yyyy === year;
    const matchesMonth = !month || mm === month;
    return matchesYear && matchesMonth;
  });
}


    </script>

<div id="auth-modal" onclick="closeAuthModal()" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000;">
<div onclick="event.stopPropagation()" class="modal-box">
    <h3 id="auth-title">Sign In</h3>
<input
  type="text"
  id="auth-username"
  placeholder="Username"
  style="width: 100%; margin-bottom: 10px; box-sizing: border-box; padding: 10px; font-size: 16px; line-height: 1.4;"
/>

<input
  type="password"
  id="auth-password"
  placeholder="Password"
  style="width: 100%; margin-bottom: 10px; box-sizing: border-box; padding: 10px; font-size: 16px; line-height: 1.4;"
/>


    <button onclick="submitAuth()" style="width: 100%;">Submit</button>
    <button onclick="closeAuthModal()" style="width: 100%; margin-top: 10px; background-color: #ccc; color: #333;">Cancel</button>
    <p style="text-align: center; margin-top: 10px;">
  <a href="#" onclick="toggleAuthMode()">Switch to <span id="auth-switch-label">Sign Up</span></a><br>
  <a href="#" onclick="showResetModal()" style="font-size: 0.9em; color: #0d6efd;">Forgot Password?</a>
</p>
  </div>
</div>

<div id="change-password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000;">
<div onclick="event.stopPropagation()" class="modal-box">
    <h3>Change Password</h3>

    <input type="password" id="current-password" placeholder="Current password"
      style="width: 100%; margin-bottom: 10px; box-sizing: border-box; padding: 10px; font-size: 16px; line-height: 1.4;" />

    <input type="password" id="new-password" placeholder="New password"
      style="width: 100%; margin-bottom: 10px; box-sizing: border-box; padding: 10px; font-size: 16px; line-height: 1.4;" />

    <input type="password" id="confirm-password" placeholder="Confirm new password"
      style="width: 100%; margin-bottom: 10px; box-sizing: border-box; padding: 10px; font-size: 16px; line-height: 1.4;" />

    <button onclick="submitPasswordChange()" style="width: 100%; padding: 10px; font-size: 16px;">Submit</button>
    <button onclick="closePasswordModal()" style="width: 100%; margin-top: 10px; background: #ccc; padding: 10px; font-size: 16px;">Cancel</button>
  </div>
</div>

<div id="reset-password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000;">
<div onclick="event.stopPropagation()" class="modal-box">
    <h3>Reset Password</h3>
    <input type="text" id="reset-username" placeholder="Username" style="width: 100%; margin-bottom: 10px; padding: 10px;" />
    <input type="text" id="reset-key" placeholder="Reset Key (shown at signup)" style="width: 100%; margin-bottom: 10px; padding: 10px;" />
    <input type="password" id="reset-new-password" placeholder="New Password" style="width: 100%; margin-bottom: 10px; padding: 10px;" />
    <button onclick="submitResetPassword()" style="width: 100%;">Submit</button>
    <button onclick="closeResetModal()" style="width: 100%; margin-top: 10px; background: #ccc;">Cancel</button>
  </div>
</div>

<div id="delete-account-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 2000;">
<div onclick="event.stopPropagation()" class="modal-box">
    <h3>Delete Account</h3>
    <p style="font-size: 14px; color: red;">âš ï¸ This action is permanent.</p>
    <input type="password" id="delete-password" placeholder="Confirm password" style="width: 100%; margin-bottom: 10px; padding: 10px;" />
    <button onclick="submitDeleteAccount()" style="width: 100%; background: red; color: white;">Delete My Account</button>
    <button onclick="closeDeleteModal()" style="width: 100%; margin-top: 10px; background: #ccc;">Cancel</button>
  </div>
</div>


</body>

</html>
