<!DOCTYPE html>
<html lang="en" style="padding-bottom: env(safe-area-inset-bottom); background: white;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none">
  
  <title>Go Route Yourself - Route and Cost Calculator with Log</title>
  
  <meta name="description" content="Easily calculate driving routes, optimize stops, track trip costs, and log your earnings. Save your routes securely and export your trip logs.">
  
  <!-- Open Graph -->
  <meta property="og:title" content="Go Route Yourself - Route and Cost Calculator">
  <meta property="og:description" content="Plan routes, calculate costs, optimize trips, and track your earnings with our smart route logging tool.">
  <meta property="og:url" content="https://gorouteyourself.com/">
  <meta property="og:type" content="website">
  <meta property="og:image" content="https://gorouteyourself.com/logo.png">
  <meta property="og:site_name" content="Go Route Yourself">
  
  <!-- PWA -->
  <link rel="icon" href="/logo-512.png" sizes="512x512" type="image/png">
  <link rel="apple-touch-icon" href="/logo-512.png">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Go Route Yourself">
  <meta name="theme-color" content="#4caf50">
  <link rel="manifest" href="/manifest.json">
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- External Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <!-- Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCOdfe7j11yw9ENkX8c7hYsIjwqcQeqJGQ&libraries=places&callback=initMap" defer></script>
  
  <style>
    /* ===== RESET & BASE ===== */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      overflow-x: hidden;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f4f9;
    }
    
    body {
      padding-top: 100px;
      padding-bottom: calc(100px + env(safe-area-inset-bottom));
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    /* ===== BUTTONS ===== */
    button {
      all: unset;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      text-align: center;
      transition: all 0.2s ease;
    }
    
    button:focus,
    button:active,
    button:focus-visible {
      outline: none !important;
      box-shadow: none !important;
    }
    
    button::-moz-focus-inner {
      border: 0;
    }
    
    .btn {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #4caf50;
      color: white;
      font-weight: 500;
      box-sizing: border-box;
    }
    
    .btn:hover {
      background-color: #45a049;
      transform: translateY(-1px);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background-color: #6c757d;
    }
    
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    
    .btn-danger {
      background-color: #dc3545;
    }
    
    .btn-danger:hover {
      background-color: #c82333;
    }
    
    /* ===== CONTAINERS ===== */
    .container,
    #log-container,
    #import-container,
    .edit-form-container {
      background-color: white;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 8px;
      width: 100%;
      max-width: 900px;
      margin: 20px auto;
      box-sizing: border-box;
    }
    
    /* ===== FORM ELEMENTS ===== */
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
      font-size: 14px;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-family: inherit;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
    }
    
    /* ===== TOP BAR ===== */
    #top-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      background: white;
      padding: 15px 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    #top-bar .logo-container {
      flex: 1;
      display: flex;
      justify-content: center;
    }
    
    #logo-image {
      height: 50px;
      max-height: 70px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    #logo-image:hover {
      transform: scale(1.05);
    }
    
    #hamburger-button {
      position: absolute;
      left: 12px;
      background: none;
      border: none;
      font-size: 28px;
      color: black;
      padding: 6px 10px;
      border-radius: 8px;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #hamburger-button:hover {
      background-color: #f0f0f0;
    }
    
    #username-display {
      position: absolute;
      right: 22px;
      font-size: 16px;
      font-weight: bold;
      padding: 6px 10px;
      border-radius: 8px;
      color: black;
    }
    
    /* ===== BOTTOM BAR ===== */
    #bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0;
      padding-bottom: env(safe-area-inset-bottom);
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
      z-index: 1000;
      touch-action: manipulation;
    }
    
    #bottom-bar button {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 5px;
      font-size: 12px;
      color: #333;
      background: transparent;
      min-height: 60px;
    }
    
    #bottom-bar button:hover {
      background-color: #f0f0f0;
    }
    
    #bottom-bar .material-icons {
      font-size: 24px;
      margin-bottom: 4px;
    }
    
    /* ===== MODALS ===== */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background-color: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
    }
    
    .modal-close:hover {
      color: #000;
    }
    
    /* ===== BANNERS ===== */
    .banner {
      display: none;
      border-radius: 6px;
      padding: 15px 20px;
      text-align: center;
      font-size: 16px;
      max-width: 600px;
      margin: 20px auto;
      position: relative;
      z-index: 500;
    }
    
    #auth-message {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }
    
    #offline-banner {
      background-color: #fffae6;
      color: #856404;
      border: 1px solid #ffd700;
    }
    
    #auth-message a,
    #offline-banner a {
      color: #0d6efd;
      font-weight: bold;
      text-decoration: none;
    }
    
    #auth-message a:hover,
    #offline-banner a:hover {
      text-decoration: underline;
    }
    
    /* ===== MAP ===== */
    #map {
      height: 450px;
      width: 100%;
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
    }
    
    .hidden {
      display: none !important;
    }
    
    /* ===== DESTINATIONS ===== */
    .destination {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
      background-color: #fafafa;
    }
    
    .destination-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .destination-actions button {
      flex: 1;
      padding: 8px;
      font-size: 14px;
    }
    
    /* ===== LOG ENTRIES ===== */
    .log-entry {
      list-style: none;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fff;
    }
    
    .log-item-details {
      margin-bottom: 10px;
    }
    
    .log-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .log-actions button {
      flex: 1;
      min-width: 80px;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
    }
    
    .log-actions button:hover {
      background-color: #0056b3;
    }
    
    .log-actions .edit-btn {
      background-color: #ffc107;
      color: black;
    }
    
    .log-actions .edit-btn:hover {
      background-color: #e0a800;
    }
    
    .log-actions button:last-child {
      background-color: #dc3545;
    }
    
    .log-actions button:last-child:hover {
      background-color: #c82333;
    }
    
    /* ===== HAMBURGER MENU ===== */
    #account-menu {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 280px;
      height: 100%;
      background: white;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      overflow-y: auto;
      padding: 20px;
    }
    
    #account-menu.active {
      display: block;
    }
    
    #menu-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1999;
    }
    
    #menu-overlay.active {
      display: block;
    }
    
    .menu-item button {
      width: 100%;
      padding: 12px;
      margin: 5px 0;
      text-align: center;
      background: #4caf50;
      color: white;
      border-radius: 5px;
      font-size: 16px;
    }
    
    .menu-item button:hover {
      background: #45a049;
    }
    
    /* ===== RESPONSIVE ===== */
    @media (max-width: 600px) {
      .container,
      #log-container,
      .edit-form-container {
        padding: 15px;
      }
      
      #bottom-bar button {
        font-size: 11px;
        padding: 8px 3px;
      }
      
      #bottom-bar .material-icons {
        font-size: 20px;
      }
      
      .log-actions {
        flex-direction: column;
      }
      
      .log-actions button {
        width: 100%;
      }
    }
    
    /* ===== UTILITIES ===== */
    .text-center {
      text-align: center;
    }
    
    .mt-20 {
      margin-top: 20px;
    }
    
    .mb-20 {
      margin-bottom: 20px;
    }
    
    h1, h2, h3 {
      color: #333;
      margin-top: 0;
    }
    
    h1 {
      font-size: 24px;
      text-align: center;
    }
    
    h2 {
      font-size: 20px;
    }
    
    /* ===== CONFIRMATION MESSAGE ===== */
    #confirmation-message {
      position: fixed;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 3000;
      display: none;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from {
        top: 80px;
        opacity: 0;
      }
      to {
        top: 100px;
        opacity: 1;
      }
    }
  </style>
</head>
<body>

<!-- Top Bar -->
<div id="top-bar">
  <button id="hamburger-button" onclick="toggleMenu()" aria-label="Menu">‚ò∞</button>
  <div class="logo-container">
    <img id="logo-image" src="/logo.png" alt="Go Route Yourself Logo" onclick="scrollToTop()">
  </div>
  <span id="username-display"></span>
</div>

<!-- Menu Overlay -->
<div id="menu-overlay" onclick="closeMenu()"></div>

<!-- Hamburger Menu -->
<div id="account-menu">
  <h2>Menu</h2>
  <div class="menu-item">
    <button onclick="showPasswordModal()">Change Password</button>
  </div>
  <div class="menu-item">
    <button onclick="triggerImportFile()">Import CSV</button>
  </div>
  <div class="menu-item">
    <button onclick="exportToCSVWithTotals()">Export CSV</button>
  </div>
  <div class="menu-item">
    <button onclick="exportToPDFWithTotals()">Export PDF</button>
  </div>
  <div class="menu-item">
    <button onclick="installApp()">Install App</button>
  </div>
  <div class="menu-item">
    <button onclick="window.open('/privacy-policy.html', '_blank')">Privacy Policy</button>
  </div>
  <div class="menu-item">
    <button onclick="window.open('/faq.html', '_blank')">FAQ</button>
  </div>
  <div class="menu-item">
    <button onclick="closeMenu(); logout()" class="btn-danger">Log Out</button>
  </div>
</div>

<!-- Auth Banner -->
<div id="auth-message" class="banner">
  üöß To log your route, you need to
  <a href="#" onclick="event.preventDefault(); showLogin();">Sign in</a>
  or
  <a href="#" onclick="event.preventDefault(); showSignup();">Create an account</a>.
</div>

<!-- Offline Banner -->
<div id="offline-banner" class="banner">
  üõú Offline Mode: Showing cached routes.
</div>

<!-- Confirmation Message -->
<div id="confirmation-message"></div>

<!-- Main Container -->
<div class="container">
  <h1>Plan Your Route</h1>
  
  <label for="log-date">Date</label>
  <input type="date" id="log-date" required>
  
  <label for="start-address">Start Address</label>
  <input type="text" id="start-address" placeholder="Enter start address" required>
  
  <div id="destinations-container">
    <div class="destination">
      <label for="destination-1">Destination 1</label>
      <input type="text" id="destination-1" list="recent-destinations" placeholder="Enter destination address" required>
      <datalist id="recent-destinations"></datalist>
      
      <label for="earnings-1">Earnings for Destination 1</label>
      <input type="number" id="earnings-1" step="0.01" min="0" placeholder="0.00">
      
      <div class="destination-actions">
        <button class="btn btn-secondary" onclick="removeDestination(this)">Remove</button>
      </div>
    </div>
  </div>
  
  <button class="btn" onclick="addDestination()">+ Add Destination</button>
  
  <label for="end-address">End Address (Optional)</label>
  <input type="text" id="end-address" placeholder="Leave blank to return to last destination">
  
  <h2 class="mt-20">Trip Details</h2>
  
  <label for="start-time">Start Time</label>
  <input type="time" id="start-time">
  
  <label for="end-time">End Time</label>
  <input type="time" id="end-time">
  
  <label for="total-hours">Total Hours Worked</label>
  <input type="text" id="total-hours" readonly placeholder="Auto-calculated">
  
  <label for="mpg">Miles Per Gallon (MPG)</label>
  <input type="number" id="mpg" step="0.1" min="0" placeholder="25">
  
  <label for="gas-price">Gas Price (per gallon)</label>
  <input type="number" id="gas-price" step="0.01" min="0" placeholder="3.50">
  
  <label for="maintenance-cost">Maintenance Cost</label>
  <input type="number" id="maintenance-cost" step="0.01" min="0" placeholder="0.00">
  
  <label for="supplies-cost">Supplies Cost</label>
  <input type="number" id="supplies-cost" step="0.01" min="0" placeholder="0.00">
  
  <label for="notes">Notes (Optional)</label>
  <textarea id="notes" rows="3" placeholder="Add any notes about this trip"></textarea>
</div>

<!-- Map Container -->
<div class="container">
  <div id="map" class="hidden"></div>
  <div id="mileage-display" class="text-center mt-20"></div>
  <div id="optimized-mileage-display" class="text-center"></div>
</div>

<!-- Log Container -->
<div id="log-container">
  <h1>Your Route Logs</h1>
  <div id="log-summary" class="text-center mb-20"></div>
  <ul id="log-list"></ul>
  <div id="pagination-controls"></div>
</div>

<!-- Bottom Navigation Bar -->
<div id="bottom-bar">
  <button onclick="calculateRoute()">
    <span class="material-icons">route</span>
    <span>Calculate</span>
  </button>
  <button onclick="optimizeRoute()">
    <span class="material-icons">alt_route</span>
    <span>Optimize</span>
  </button>
  <button onclick="logResults()">
    <span class="material-icons">save</span>
    <span>Log Route</span>
  </button>
  <button onclick="openInGoogleMaps()">
    <span class="material-icons">map</span>
    <span>Open Maps</span>
  </button>
</div>

<!-- Universal Modal -->
<div id="universal-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeUniversalModal()">&times;</span>
    <div id="universal-modal-message"></div>
    <div id="universal-modal-buttons" class="mt-20"></div>
  </div>
</div>

<!-- Auth Modal -->
<div id="auth-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeAuthModal()">&times;</span>
    <h2 id="auth-modal-title">Sign In</h2>
    <input type="text" id="auth-username" placeholder="Username">
    <input type="password" id="auth-password" placeholder="Password">
    <button class="btn" onclick="submitAuth()">Continue</button>
    <p class="text-center mt-20">
      <a href="#" id="auth-toggle-link" onclick="event.preventDefault(); toggleAuthMode();">Create an account</a>
    </p>
  </div>
</div>

<!-- Password Change Modal -->
<div id="change-password-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closePasswordModal()">&times;</span>
    <h2>Change Password</h2>
    <input type="password" id="current-password" placeholder="Current Password">
    <input type="password" id="new-password" placeholder="New Password">
    <input type="password" id="confirm-password" placeholder="Confirm New Password">
    <button class="btn" onclick="submitPasswordChange()">Change Password</button>
  </div>
</div>

<!-- Hidden File Input for CSV Import -->
<input type="file" id="file-input" accept=".csv" style="display: none;" onchange="importFromCSV(event)">

<script>
  // Global variables
  let map;
  let directionsService;
  let directionsRenderer;
  let logEntries = [];
  let currentPage = 1;
  let entriesPerPage = 10;
  let originalMileage = null;
  let isSignupMode = false;
  let skipNextSync = false;

  // Initialize Google Maps
  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      zoom: 7,
      center: { lat: 41.85, lng: -87.65 }
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    directionsRenderer.setMap(map);
    
    // Initialize autocomplete for addresses
    initAutocomplete();
  }

  // Initialize autocomplete for address inputs
  function initAutocomplete() {
    const startInput = document.getElementById("start-address");
    const endInput = document.getElementById("end-address");
    
    if (startInput) new google.maps.places.Autocomplete(startInput);
    if (endInput) new google.maps.places.Autocomplete(endInput);
    
    // Initialize for existing destinations
    document.querySelectorAll('[id^="destination-"]').forEach(input => {
      new google.maps.places.Autocomplete(input);
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', async function() {
    // Set today's date
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('log-date').value = today;
    
    // Check auth status
    updateAuthUI();
    
    // Load saved logs if logged in
    if (localStorage.getItem('token')) {
      logEntries = await loadLog();
      displayLog();
    }
    
    // Setup online/offline detection
    window.addEventListener('online', updateOfflineBanner);
    window.addEventListener('offline', updateOfflineBanner);
    updateOfflineBanner();
    
    // Check for draft trip
    checkForDraftTrip();
  });

  // Auth functions
  function updateAuthUI() {
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');
    const authMessage = document.getElementById('auth-message');
    const usernameDisplay = document.getElementById('username-display');
    
    if (token && username) {
      authMessage.style.display = 'none';
      usernameDisplay.textContent = username;
    } else {
      authMessage.style.display = 'block';
      usernameDisplay.textContent = '';
    }
  }

  function showLogin() {
    isSignupMode = false;
    document.getElementById('auth-modal-title').textContent = 'Sign In';
    document.getElementById('auth-toggle-link').textContent = 'Create an account';
    document.getElementById('auth-modal').style.display = 'flex';
  }

  function showSignup() {
    isSignupMode = true;
    document.getElementById('auth-modal-title').textContent = 'Create Account';
    document.getElementById('auth-toggle-link').textContent = 'Already have an account? Sign in';
    document.getElementById('auth-modal').style.display = 'flex';
  }

  function toggleAuthMode() {
    if (isSignupMode) {
      showLogin();
    } else {
      showSignup();
    }
  }

  function closeAuthModal() {
    document.getElementById('auth-modal').style.display = 'none';
    document.getElementById('auth-username').value = '';
    document.getElementById('auth-password').value = '';
  }

  async function submitAuth() {
    const username = document.getElementById('auth-username').value.trim();
    const password = document.getElementById('auth-password').value.trim();
    
    if (!username || !password) {
      showAlertModal('‚ö†Ô∏è Please enter both username and password.');
      return;
    }
    
    const endpoint = isSignupMode
      ? 'https://logs.gorouteyourself.com/api/signup'
      : 'https://logs.gorouteyourself.com/api/login';
    
    try {
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      
      if (res.ok) {
        const data = await res.json();
        localStorage.setItem('username', username);
        localStorage.setItem('token', data.token);
        closeAuthModal();
        showConfirmationMessage(`‚úÖ ${isSignupMode ? 'Account created' : 'Signed in'} successfully!`);
        updateAuthUI();
        
        if (isSignupMode && data.resetKey) {
          showAlertModal(
            `üîê Your reset key is:<br><br><code style="font-size: 18px; user-select: all;">${data.resetKey}</code><br><br>Save this key somewhere safe.`,
            () => location.reload()
          );
        } else {
          location.reload();
        }
      } else {
        let msg = '‚ùå An error occurred.';
        try {
          const data = await res.json();
          msg = '‚ùå ' + (data.error || msg);
        } catch (e) {
          msg = '‚ùå ' + (await res.text());
        }
        
        if (res.status === 400 && msg.toLowerCase().includes('username')) {
          msg = '‚ùå That username is already taken. Please choose another.';
        }
        
        if (res.status === 404 && msg.toLowerCase().includes('not found')) {
          msg = '‚ùå Account not found. Please check your username or sign up.';
        }
        
        showAlertModal(msg);
      }
    } catch (error) {
      showAlertModal('‚ùå Connection error. Please try again.');
      console.error('Auth error:', error);
    }
  }

  function logout() {
    localStorage.removeItem('token');
    localStorage.removeItem('username');
    showConfirmationMessage('üëã Logged out successfully.');
    location.reload();
  }

  // Menu functions
  function toggleMenu() {
    const menu = document.getElementById('account-menu');
    const overlay = document.getElementById('menu-overlay');
    menu.classList.toggle('active');
    overlay.classList.toggle('active');
  }

  function closeMenu() {
    document.getElementById('account-menu').classList.remove('active');
    document.getElementById('menu-overlay').classList.remove('active');
  }

  // Scroll to top
  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // Modal functions
  function showAlertModal(message, onClose) {
    const modal = document.getElementById('universal-modal');
    const msg = document.getElementById('universal-modal-message');
    const buttons = document.getElementById('universal-modal-buttons');
    
    msg.innerHTML = message;
    window._universalCallback = typeof onClose === 'function' ? onClose : null;
    
    buttons.innerHTML = `
      <button class="btn" onclick="closeUniversalModal(); if (typeof window._universalCallback === 'function') window._universalCallback();">OK</button>
    `;
    
    modal.style.display = 'flex';
  }

  function closeUniversalModal() {
    document.getElementById('universal-modal').style.display = 'none';
  }

  // Confirmation message
  function showConfirmationMessage(message) {
    const div = document.getElementById('confirmation-message');
    div.textContent = message;
    div.style.display = 'block';
    
    setTimeout(() => {
      div.style.display = 'none';
    }, 3000);
  }

  // Offline detection
  function updateOfflineBanner() {
    const banner = document.getElementById('offline-banner');
    
    if (navigator.onLine) {
      banner.style.display = 'none';
      syncAndReloadLogs();
    } else {
      banner.style.display = 'block';
    }
  }

  async function syncAndReloadLogs() {
    if (skipNextSync) {
      skipNextSync = false;
      return;
    }
    
    try {
      await syncPendingLogs();
      logEntries = await loadLog();
      displayLog();
      showConfirmationMessage('‚úÖ Logs refreshed!');
    } catch (err) {
      console.error('Error syncing:', err);
    }
  }

  // Destination management
  let destinationCount = 1;

  function addDestination() {
    destinationCount++;
    const container = document.getElementById('destinations-container');
    const div = document.createElement('div');
    div.className = 'destination';
    div.innerHTML = `
      <label for="destination-${destinationCount}">Destination ${destinationCount}</label>
      <input type="text" id="destination-${destinationCount}" list="recent-destinations" placeholder="Enter destination address" required>
      
      <label for="earnings-${destinationCount}">Earnings for Destination ${destinationCount}</label>
      <input type="number" id="earnings-${destinationCount}" step="0.01" min="0" placeholder="0.00">
      
      <div class="destination-actions">
        <button class="btn btn-secondary" onclick="removeDestination(this)">Remove</button>
      </div>
    `;
    container.appendChild(div);
    
    // Initialize autocomplete for new destination
    const newInput = div.querySelector('input[type="text"]');
    if (newInput) new google.maps.places.Autocomplete(newInput);
  }

  function removeDestination(button) {
    const destination = button.closest('.destination');
    destination.remove();
    renumberDestinations();
  }

  function renumberDestinations() {
    const destinations = document.querySelectorAll('.destination');
    destinations.forEach((dest, index) => {
      const num = index + 1;
      const destInput = dest.querySelector('input[type="text"]');
      const earningsInput = dest.querySelector('input[type="number"]');
      const destLabel = dest.querySelector('label');
      const earningsLabel = dest.querySelectorAll('label')[1];
      
      if (destInput) {
        destInput.id = `destination-${num}`;
        destLabel.setAttribute('for', `destination-${num}`);
        destLabel.textContent = `Destination ${num}`;
      }
      
      if (earningsInput) {
        earningsInput.id = `earnings-${num}`;
        earningsLabel.setAttribute('for', `earnings-${num}`);
        earningsLabel.textContent = `Earnings for Destination ${num}`;
      }
    });
    
    destinationCount = destinations.length;
  }

  // Route calculation
  async function calculateRoute() {
    const startAddress = document.getElementById('start-address').value.trim();
    
    if (!startAddress) {
      showAlertModal('üöß Please enter a start address.');
      return;
    }
    
    const destInputs = document.querySelectorAll('input[id^="destination-"]');
    const filledDests = Array.from(destInputs).filter(input => input.value.trim() !== '');
    
    if (filledDests.length === 0) {
      showAlertModal('üöß Please enter at least one destination.');
      return;
    }
    
    const result = await calculateRouteData();
    if (result) {
      showConfirmationMessage('‚úÖ Route calculated successfully!');
      document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
    }
  }

  async function calculateRouteData() {
    const startAddress = document.getElementById('start-address').value.trim();
    const endAddress = document.getElementById('end-address').value.trim();
    const mpg = parseFloat(document.getElementById('mpg').value) || 0;
    const gasPrice = parseFloat(document.getElementById('gas-price').value) || 0;
    const maintenanceCost = parseFloat(document.getElementById('maintenance-cost').value) || 0;
    const suppliesCost = parseFloat(document.getElementById('supplies-cost').value) || 0;
    
    // Get destinations and earnings
    const destInputs = document.querySelectorAll('input[id^="destination-"]');
    const earningsInputs = document.querySelectorAll('input[id^="earnings-"]');
    
    const destinations = Array.from(destInputs)
      .map(input => input.value.trim())
      .filter(val => val !== '');
    
    const earnings = Array.from(earningsInputs)
      .map(input => parseFloat(input.value) || 0);
    
    const totalEarnings = earnings.reduce((sum, val) => sum + val, 0);
    
    if (destinations.length === 0) {
      showAlertModal('üöß Please enter at least one destination.');
      return null;
    }
    
    // Build waypoints
    const waypoints = destinations.map(location => ({
      location: location,
      stopover: true
    }));
    
    const request = {
      origin: startAddress,
      destination: endAddress || destinations[destinations.length - 1] || startAddress,
      waypoints: waypoints,
      travelMode: 'DRIVING'
    };
    
    if (!navigator.onLine) {
      showAlertModal('üõú You\'re offline. Route calculation is unavailable until you\'re reconnected.');
      return null;
    }
    
    return new Promise((resolve) => {
      directionsService.route(request, (response, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(response);
          document.getElementById('map').classList.remove('hidden');
          
          let totalMileage = 0;
          let totalDuration = 0;
          
          response.routes[0].legs.forEach(leg => {
            totalMileage += leg.distance.value / 1609.34;
            totalDuration += leg.duration.value;
          });
          
          const fuelCost = mpg && gasPrice ? (totalMileage / mpg) * gasPrice : 0;
          const netProfit = totalEarnings - fuelCost - maintenanceCost - suppliesCost;
          
          // Calculate hours worked
          const startTime = document.getElementById('start-time').value;
          const endTime = document.getElementById('end-time').value;
          let hoursWorked = 0;
          
          if (startTime && endTime) {
            const [startHours, startMinutes] = startTime.split(':').map(Number);
            const [endHours, endMinutes] = endTime.split(':').map(Number);
            let startTotalMinutes = startHours * 60 + startMinutes;
            let endTotalMinutes = endHours * 60 + endMinutes;
            if (endTotalMinutes < startTotalMinutes) endTotalMinutes += 24 * 60;
            const totalWorkedMinutes = endTotalMinutes - startTotalMinutes;
            hoursWorked = totalWorkedMinutes / 60;
            document.getElementById('total-hours').value = formatHoursAndMinutes(hoursWorked);
          }
          
          const profitPerHour = hoursWorked > 0 ? (netProfit / hoursWorked) : 0;
          
          // Display mileage
          const mileageDisplay = document.getElementById('mileage-display');
          mileageDisplay.textContent = `Total Mileage: ${totalMileage.toFixed(2)} miles`;
          
          const result = {
            date: document.getElementById('log-date').value,
            startAddress: startAddress,
            endAddress: endAddress,
            destinations: destinations,
            earnings: earnings,
            totalEarnings: totalEarnings.toFixed(2),
            totalMileage: totalMileage.toFixed(2),
            totalTime: formatDuration(totalDuration),
            fuelCost: fuelCost.toFixed(2),
            maintenanceCost: maintenanceCost.toFixed(2),
            suppliesCost: suppliesCost.toFixed(2),
            netProfit: netProfit.toFixed(2),
            profitPerHour: profitPerHour.toFixed(2),
            mpg: mpg,
            gasPrice: gasPrice,
            startTime: startTime,
            endTime: endTime,
            hoursWorked: hoursWorked.toFixed(2),
            notes: document.getElementById('notes').value.trim()
          };
          
          resolve(result);
        } else {
          showAlertModal('‚ùå Could not calculate route. Please check your addresses.');
          resolve(null);
        }
      });
    });
  }

  function formatDuration(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    return `${hours}h ${minutes}m`;
  }

  function formatHoursAndMinutes(hours) {
    const h = Math.floor(hours);
    const m = Math.round((hours - h) * 60);
    return `${h}h ${m}m`;
  }

  // Log route
  async function logResults() {
    const token = localStorage.getItem('token');
    if (!token) {
      showAlertModal('‚ùå You must sign in to log your route.', showLogin);
      return;
    }
    
    const destInputs = document.querySelectorAll('input[id^="destination-"]');
    const filledDests = Array.from(destInputs).filter(input => input.value.trim() !== '');
    
    if (filledDests.length === 0) {
      showAlertModal('üöß Please enter at least one destination before logging your route.');
      return;
    }
    
    const result = await calculateRouteData();
    if (result) {
      logEntries.unshift(result);
      await saveLog();
      displayLog();
      clearTripForm();
      showConfirmationMessage('‚úÖ Route logged successfully!');
    }
  }

  function clearTripForm() {
    // Reset destinations
    const container = document.getElementById('destinations-container');
    container.innerHTML = `
      <div class="destination">
        <label for="destination-1">Destination 1</label>
        <input type="text" id="destination-1" list="recent-destinations" placeholder="Enter destination address" required>
        <datalist id="recent-destinations"></datalist>
        
        <label for="earnings-1">Earnings for Destination 1</label>
        <input type="number" id="earnings-1" step="0.01" min="0" placeholder="0.00">
        
        <div class="destination-actions">
          <button class="btn btn-secondary" onclick="removeDestination(this)">Remove</button>
        </div>
      </div>
    `;
    destinationCount = 1;
    initAutocomplete();
    
    // Reset other fields
    document.getElementById('start-address').value = '';
    document.getElementById('end-address').value = '';
    document.getElementById('start-time').value = '';
    document.getElementById('end-time').value = '';
    document.getElementById('total-hours').value = '';
    document.getElementById('notes').value = '';
    
    // Reset date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('log-date').value = today;
    
    // Hide map
    document.getElementById('map').classList.add('hidden');
    document.getElementById('mileage-display').textContent = '';
  }

  // Save and load logs
  async function saveLog() {
    const token = localStorage.getItem('token');
    if (!token) {
      showAlertModal('‚ùå You must be signed in to save.', showLogin);
      return;
    }
    
    if (!navigator.onLine) {
      localStorage.setItem('pendingLogs', JSON.stringify(logEntries));
      localStorage.setItem('cachedLogs', JSON.stringify(logEntries));
      showAlertModal('‚ö†Ô∏è Offline: Route saved locally. Will sync when back online.');
      return;
    }
    
    try {
      const response = await fetch('https://logs.gorouteyourself.com/logs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify(logEntries)
      });
      
      if (!response.ok) {
        throw new Error(await response.text());
      }
      
      await syncAndReloadLogs();
    } catch (err) {
      console.error('Save failed:', err);
      localStorage.setItem('pendingLogs', JSON.stringify(logEntries));
      localStorage.setItem('cachedLogs', JSON.stringify(logEntries));
      showAlertModal('‚ö†Ô∏è Offline mode: Your changes are saved locally. We\'ll sync them next time you\'re online.');
    }
  }

  async function loadLog() {
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('No token found');
      return [];
    }
    
    try {
      const response = await fetch('https://logs.gorouteyourself.com/logs', {
        headers: { 'Authorization': token }
      });
      
      if (!response.ok) {
        throw new Error(await response.text());
      }
      
      const logs = await response.json();
      localStorage.setItem('cachedLogs', JSON.stringify(logs));
      return logs;
    } catch (err) {
      console.warn('Loading from cache:', err);
      const cached = localStorage.getItem('cachedLogs');
      return cached ? JSON.parse(cached) : [];
    }
  }

  async function syncPendingLogs() {
    const pending = localStorage.getItem('pendingLogs');
    if (!pending) return;
    
    const token = localStorage.getItem('token');
    if (!token) return;
    
    try {
      const response = await fetch('https://logs.gorouteyourself.com/logs', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: pending
      });
      
      if (response.ok) {
        localStorage.removeItem('pendingLogs');
        const freshLogs = await loadLog();
        localStorage.setItem('cachedLogs', JSON.stringify(freshLogs));
      }
    } catch (err) {
      console.error('Sync failed:', err);
    }
  }

  // Display logs
  function displayLog() {
    const logList = document.getElementById('log-list');
    logList.innerHTML = '';
    
    if (logEntries.length === 0) {
      logList.innerHTML = '<li class="log-entry text-center">No routes logged yet. Start by calculating and logging a route!</li>';
      return;
    }
    
    const totalPages = Math.ceil(logEntries.length / entriesPerPage);
    const start = (currentPage - 1) * entriesPerPage;
    const end = start + entriesPerPage;
    const pageEntries = logEntries.slice(start, end);
    
    pageEntries.forEach((entry, index) => {
      const realIndex = start + index;
      const listItem = document.createElement('li');
      listItem.className = 'log-entry';
      
      listItem.innerHTML = `
        <div class="log-item-details">
          <strong>Date:</strong> ${entry.date}<br>
          <strong>Destinations:</strong><br>
          <div style="margin-left: 20px;">
            ${(entry.destinations || []).map(dest => `- ${dest}`).join('<br>')}
          </div>
          <strong>Net Profit:</strong> $${parseFloat(entry.netProfit || 0).toFixed(2)}<br>
          <strong>Mileage:</strong> ${entry.totalMileage} miles
        </div>
        <div class="log-actions">
          <button onclick="viewLogDetails(${realIndex})">View Details</button>
          <button class="edit-btn" onclick="editLog(${realIndex})">Edit</button>
          <button onclick="deleteLog(${realIndex})">Delete</button>
        </div>
      `;
      
      logList.appendChild(listItem);
    });
    
    renderPagination(totalPages);
    updateLogSummary();
  }

  function renderPagination(totalPages) {
    let paginationContainer = document.getElementById('pagination-controls');
    if (!paginationContainer) {
      paginationContainer = document.createElement('div');
      paginationContainer.id = 'pagination-controls';
      document.getElementById('log-container').appendChild(paginationContainer);
    }
    
    paginationContainer.innerHTML = `
      <div class="text-center mb-20">Page ${currentPage} of ${totalPages}</div>
      <div style="display: flex; justify-content: center; gap: 10px;">
        <button class="btn" onclick="prevPage()" ${currentPage === 1 ? 'disabled' : ''}>Previous</button>
        <button class="btn" onclick="nextPage()" ${currentPage === totalPages ? 'disabled' : ''}>Next</button>
      </div>
    `;
  }

  function prevPage() {
    if (currentPage > 1) {
      currentPage--;
      displayLog();
    }
  }

  function nextPage() {
    const totalPages = Math.ceil(logEntries.length / entriesPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      displayLog();
    }
  }

  function updateLogSummary() {
    const summary = document.getElementById('log-summary');
    if (logEntries.length === 0) {
      summary.innerHTML = '';
      return;
    }
    
    const totalEarnings = logEntries.reduce((sum, entry) => sum + parseFloat(entry.totalEarnings || 0), 0);
    const totalProfit = logEntries.reduce((sum, entry) => sum + parseFloat(entry.netProfit || 0), 0);
    const totalMiles = logEntries.reduce((sum, entry) => sum + parseFloat(entry.totalMileage || 0), 0);
    
    summary.innerHTML = `
      <strong>Summary:</strong> ${logEntries.length} trips | 
      Total Earnings: $${totalEarnings.toFixed(2)} | 
      Net Profit: $${totalProfit.toFixed(2)} | 
      Total Miles: ${totalMiles.toFixed(2)}
    `;
  }

  function viewLogDetails(index) {
    const entry = logEntries[index];
    const details = `
      <strong>Date:</strong> ${entry.date}<br>
      <strong>Start:</strong> ${entry.startAddress}<br>
      <strong>End:</strong> ${entry.endAddress || 'Same as last destination'}<br>
      <strong>Destinations:</strong><br>
      <div style="margin-left: 20px;">
        ${(entry.destinations || []).map((dest, i) => `${i + 1}. ${dest} - $${entry.earnings[i] || 0}`).join('<br>')}
      </div>
      <strong>Total Earnings:</strong> $${entry.totalEarnings}<br>
      <strong>Mileage:</strong> ${entry.totalMileage} miles<br>
      <strong>Travel Time:</strong> ${entry.totalTime}<br>
      <strong>Fuel Cost:</strong> $${entry.fuelCost}<br>
      <strong>Maintenance:</strong> $${entry.maintenanceCost}<br>
      <strong>Supplies:</strong> $${entry.suppliesCost}<br>
      <strong>Net Profit:</strong> $${entry.netProfit}<br>
      <strong>Hours Worked:</strong> ${entry.hoursWorked}h<br>
      <strong>Profit/Hour:</strong> $${entry.profitPerHour}<br>
      ${entry.notes ? `<strong>Notes:</strong> ${entry.notes}` : ''}
    `;
    showAlertModal(details);
  }

  async function deleteLog(index) {
    if (!confirm('Are you sure you want to delete this log entry?')) return;
    
    logEntries.splice(index, 1);
    await saveLog();
    displayLog();
    showConfirmationMessage('‚úÖ Log deleted successfully!');
  }

  // Optimize route
  async function optimizeRoute() {
    const destInputs = document.querySelectorAll('input[id^="destination-"]');
    const currentDests = Array.from(destInputs)
      .map(input => input.value.trim())
      .filter(val => val !== '');
    
    if (currentDests.length < 2) {
      showAlertModal('üöß Please add at least two destinations to optimize the route.');
      return;
    }
    
    if (originalMileage === null) {
      const result = await calculateRouteData();
      if (result && result.totalMileage) {
        originalMileage = parseFloat(result.totalMileage);
        document.getElementById('mileage-display').textContent =
          `Original Route: ${originalMileage.toFixed(2)} miles`;
      }
    }
    
    const startAddress = document.getElementById('start-address').value;
    const endAddress = document.getElementById('end-address').value;
    
    const waypoints = currentDests.map(location => ({
      location,
      stopover: true
    }));
    
    const request = {
      origin: startAddress,
      destination: endAddress || currentDests[currentDests.length - 1],
      waypoints,
      travelMode: 'DRIVING',
      optimizeWaypoints: true
    };
    
    directionsService.route(request, (response, status) => {
      if (status === 'OK' && response.routes[0].waypoint_order) {
        const optimizedOrder = response.routes[0].waypoint_order;
        const container = document.getElementById('destinations-container');
        const newContainer = document.createElement('div');
        newContainer.id = 'destinations-container';
        
        optimizedOrder.forEach((orderIndex, i) => {
          const originalDiv = destInputs[orderIndex].closest('.destination');
          const clone = originalDiv.cloneNode(true);
          
          const destInput = clone.querySelector('input[type="text"]');
          const earningsInput = clone.querySelector('input[type="number"]');
          const newIndex = i + 1;
          
          destInput.id = `destination-${newIndex}`;
          earningsInput.id = `earnings-${newIndex}`;
          
          const destLabel = clone.querySelector('label');
          const earningsLabel = clone.querySelectorAll('label')[1];
          destLabel.setAttribute('for', `destination-${newIndex}`);
          destLabel.textContent = `Destination ${newIndex}`;
          earningsLabel.setAttribute('for', `earnings-${newIndex}`);
          earningsLabel.textContent = `Earnings for Destination ${newIndex}`;
          
          newContainer.appendChild(clone);
        });
        
        container.parentNode.replaceChild(newContainer, container);
        destinationCount = optimizedOrder.length;
        
        // Recalculate with optimized order
        calculateRouteData().then(result => {
          if (result) {
            const optimizedMileage = parseFloat(result.totalMileage);
            const savings = originalMileage - optimizedMileage;
            document.getElementById('optimized-mileage-display').textContent =
              `Optimized Route: ${optimizedMileage.toFixed(2)} miles (saved ${savings.toFixed(2)} miles)`;
            showConfirmationMessage('‚úÖ Route optimized!');
          }
        });
      } else {
        showAlertModal('‚ùå Could not optimize route.');
      }
    });
  }

  // Open in Google Maps
  function openInGoogleMaps() {
    const start = encodeURIComponent(document.getElementById('start-address').value);
    const endInput = document.getElementById('end-address').value.trim();
    
    const destInputs = Array.from(document.querySelectorAll('input[id^="destination-"]'))
      .map(input => input.value.trim())
      .filter(dest => dest.length > 0);
    
    const end = encodeURIComponent(endInput || destInputs[destInputs.length - 1] || start);
    const destinations = destInputs.filter(dest => dest !== endInput);
    
    let url = `https://www.google.com/maps/dir/?api=1&origin=${start}&destination=${end}`;
    
    if (destinations.length > 0) {
      url += `&waypoints=${destinations.map(encodeURIComponent).join('|')}`;
    }
    
    window.open(url, '_blank');
  }

  // Password change
  function showPasswordModal() {
    closeMenu();
    document.getElementById('change-password-modal').style.display = 'flex';
  }

  function closePasswordModal() {
    document.getElementById('change-password-modal').style.display = 'none';
    document.getElementById('current-password').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('confirm-password').value = '';
  }

  async function submitPasswordChange() {
    const current = document.getElementById('current-password').value.trim();
    const newPass = document.getElementById('new-password').value.trim();
    const confirm = document.getElementById('confirm-password').value.trim();
    
    if (!current || !newPass || !confirm) {
      showAlertModal('‚ö†Ô∏è Please fill out all fields.');
      return;
    }
    
    if (newPass !== confirm) {
      showAlertModal('‚ùå New passwords do not match.');
      return;
    }
    
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username');
    
    try {
      const res = await fetch('https://logs.gorouteyourself.com/api/change-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': token
        },
        body: JSON.stringify({ username, currentPassword: current, newPassword: newPass })
      });
      
      if (res.ok) {
        closePasswordModal();
        showConfirmationMessage('‚úÖ Password changed successfully!');
      } else {
        const data = await res.json();
        showAlertModal('‚ùå ' + (data.error || 'Failed to change password.'));
      }
    } catch (err) {
      showAlertModal('‚ùå Connection error. Please try again.');
    }
  }

  // CSV Import/Export
  function triggerImportFile() {
    closeMenu();
    document.getElementById('file-input').click();
  }

  function importFromCSV(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      const lines = text.split('\n');
      const imported = [];
      
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        
        const parts = line.split(',');
        if (parts.length < 10) continue;
        
        imported.push({
          date: parts[0],
          startAddress: parts[1],
          endAddress: parts[2],
          destinations: parts[3].split('|').filter(d => d),
          totalEarnings: parts[4],
          totalMileage: parts[5],
          totalTime: parts[6],
          fuelCost: parts[7],
          netProfit: parts[8],
          notes: parts[9] || ''
        });
      }
      
      if (imported.length > 0) {
        logEntries = [...imported, ...logEntries];
        saveLog();
        displayLog();
        showConfirmationMessage(`‚úÖ Imported ${imported.length} routes!`);
      }
    };
    reader.readAsText(file);
  }

  function exportToCSVWithTotals() {
    closeMenu();
    
    let csv = 'Date,Start,End,Destinations,Earnings,Mileage,Time,Fuel Cost,Net Profit,Notes\n';
    
    logEntries.forEach(entry => {
      const destinations = (entry.destinations || []).join('|');
      csv += `${entry.date},${entry.startAddress},${entry.endAddress},${destinations},`;
      csv += `${entry.totalEarnings},${entry.totalMileage},${entry.totalTime},`;
      csv += `${entry.fuelCost},${entry.netProfit},"${entry.notes || ''}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `route-logs-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    showConfirmationMessage('‚úÖ CSV exported!');
  }

  function exportToPDFWithTotals() {
    closeMenu();
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(18);
    doc.text('Route Logs', 14, 22);
    
    doc.setFontSize(10);
    doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 30);
    
    const tableData = logEntries.map(entry => [
      entry.date,
      entry.startAddress,
      (entry.destinations || []).join(', '),
      `$${entry.totalEarnings}`,
      `${entry.totalMileage} mi`,
      `$${entry.netProfit}`
    ]);
    
    doc.autoTable({
      startY: 35,
      head: [['Date', 'Start', 'Destinations', 'Earnings', 'Mileage', 'Net Profit']],
      body: tableData,
      theme: 'grid',
      headStyles: { fillColor: [76, 175, 80] },
      styles: { fontSize: 8 }
    });
    
    doc.save(`route-logs-${new Date().toISOString().split('T')[0]}.pdf`);
    
    showConfirmationMessage('‚úÖ PDF exported!');
  }

  // PWA Install
  let deferredPrompt;

  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
  });

  function installApp() {
    closeMenu();
    
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          showConfirmationMessage('‚úÖ App installed!');
        }
        deferredPrompt = null;
      });
    } else {
      showAlertModal('App is already installed or not available for installation on this device.');
    }
  }

  // Draft trip management
  function checkForDraftTrip() {
    const draft = localStorage.getItem('draftTrip');
    if (draft && localStorage.getItem('token')) {
      // Could implement draft recovery here
    }
  }

  // Service Worker Registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('Service Worker registered'))
        .catch(err => console.error('Service Worker registration failed:', err));
    });
  }
</script>

</body>
</html>
