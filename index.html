    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route and Cost Calculator with Log</title>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCHrNRHP9LNGVHi9Srk1Gfcrv-4ee_gUHQ&amp;libraries=places&amp;callback=initMap" async="" defer=""></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px 0;
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: flex-start; /* Align items to the top for better flow */
            min-height: 100vh;
            flex-direction: column;
        }

        .container, #log-container, #import-container, #export-options, .edit-form-container {
            background-color: white;
            box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 8px;
            width: 100%;
            max-width: 700px;
            margin-bottom: 20px;
            box-sizing: border-box;
            overflow: auto;
        }

        #export-options, #import-container {
            text-align: center;
        }

        #export-options button, #import-container button, #import-container input[type="file"] {
            margin: 5px 10px;
            padding: 10px 15px;
            font-size: 16px;
        }

        h1 {
            text-align: center;
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], input[type="number"], button, select {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        button:hover {
            background-color: #45a049;
        }

        #results {
            display: none;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #map {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            flex-shrink: 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .destination {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            background-color: #fefefe;
        }

        .destination label {
            margin-top: 0;
        }

        .destination input {
            margin-bottom: 8px;
        }

        .delete-btn, .move-btn {
            background-color: red;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-right: 5px;
            margin-top: 5px;
        }

        .delete-btn:hover, .move-btn:hover {
            background-color: darkred;
        }

        .move-btn {
            background-color: #ffa500;
        }

        .move-btn:hover {
            background-color: #ff7f00;
        }

        .destination-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        #log-list {
            list-style-type: none;
            padding: 0;
        }

        #log-list li {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #log-list li:last-child {
            border-bottom: none;
        }

        .log-item-details {
            flex-grow: 1;
            margin-right: 10px;
        }

        .log-actions button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
        }

        .log-actions button:hover {
            background-color: #0056b3;
        }

        #log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        #organize-by-day {
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 16px;
        }

        .hidden {
            display: none;
        }

        .optional-costs {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        .optional-costs label {
            font-weight: normal;
        }

        #export-options button {
            margin: 5px 10px;
            padding: 10px 15px;
            font-size: 16px;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #333;
        }

        .edit-btn:hover {
            background-color: #e0a800;
        }

        .save-btn, .cancel-btn {
            background-color: #28a745;
            color: white;
            margin-left: 5px;
        }

        .cancel-btn {
            background-color: #dc3545;
        }

        .edit-form-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }

        .edit-form-container label {
            font-weight: normal;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    

    <div class="container">
        <h1>Route and Cost Calculator</h1>

        <label for="start-address">Start Address</label>
        <input type="text" id="start-address" placeholder="Enter start address" required="">

        <div id="destinations-container">
            <div class="destination">
                <label for="destination-1">Destination 1</label>
                <input type="text" id="destination-1" placeholder="Enter destination address" required="">
                <label for="earnings-1">Earnings for Destination 1</label>
                <input type="number" id="earnings-1" placeholder="Enter earnings for destination" required="">
                <div class="destination-actions">
                    <button class="delete-btn" onclick="deleteDestination(this)">Delete</button>
                    <button class="move-btn" onclick="moveDestinationUp(this)">Move Up</button>
                    <button class="move-btn" onclick="moveDestinationDown(this)">Move Down</button>
                </div>
            </div>
        </div>

        <button onclick="addDestination()">Add Destination</button>

        <label for="end-address">End Address</label>
        <input type="text" id="end-address" placeholder="Enter end address" required="">

        <label for="mpg">Miles per Gallon (MPG)</label>
        <input type="number" id="mpg" placeholder="Enter miles per gallon" required="">

        <label for="gas-price">Gas Price per Gallon</label>
        <input type="number" id="gas-price" placeholder="Enter gas price per gallon" required="">

        <label for="hours-worked">Hours Worked (Optional)</label>
        <input type="number" id="hours-worked" placeholder="Enter total hours worked">

        <div class="optional-costs">
            <h3>Optional Daily Costs</h3>
            <label for="maintenance-cost">Vehicle Maintenance Cost (Optional)</label>
            <input type="number" id="maintenance-cost" placeholder="Enter maintenance cost for the day" value="0">

            <label for="supplies-cost">Supplies Cost (Optional)</label>
            <input type="number" id="supplies-cost" placeholder="Enter supplies cost for the day" value="0">
        </div>

        <button onclick="calculateAndLog()">Calculate and Log</button>

        <div id="results" class="hidden">
            <p>Total Mileage: <span id="total-mileage"></span> miles</p>
            <p>Total Drive Time: <span id="total-time"></span></p>
            <p>Total Earnings: $<span id="total-earnings"></span></p>
            <p>Fuel Cost: $<span id="fuel-cost"></span></p>
            <p>Maintenance Cost: $<span id="maintenance-cost-result"></span></p>
            <p>Supplies Cost: $<span id="supplies-cost-result"></span></p>
            <p>Net Profit: $<span id="net-profit"></span></p>
            <p>Net Profit per Hour (including drive time): $<span id="profit-per-hour"></span></p>
        </div>

        <div id="map" class="hidden"></div>
    </div>

    <div id="log-container">
        <div id="log-header">
            <h2>Profit Log</h2>
            <div>
                <label for="organize-by-day">Organize by Day:</label>
                <select id="organize-by-day" onchange="displayLog(this.value)">
                    <option value="all">All</option>
                </select>
            </div>
        </div>
        <ul id="log-list">
        </ul>
    </div>

    <div id="export-options">
        <h3>Export Log</h3>
        <button onclick="exportToCSV()">Export to CSV</button>
        <button onclick="exportToPDF()">Export to PDF</button>
    </div>

    <div id="import-container">
        <h3>Import Log</h3>
        <input type="file" id="import-file" accept=".csv">
        <button onclick="importLog()">Import Log</button>
    </div>

    <div id="overlay" class="hidden"></div>

    <div id="edit-form-container" class="edit-form-container hidden">
        <h3>Edit Log Entry</h3>
        <label for="edit-date">Date</label>
        <input type="text" id="edit-date">

        <label for="edit-start-address">Start Address</label>
        <input type="text" id="edit-start-address">

        <div id="edit-destinations-container">
            </div>
        <button type="button" onclick="addEditDestination()">Add Destination</button>

        <label for="edit-end-address">End Address</label>
        <input type="text" id="edit-end-address">

        <label for="edit-total-earnings">Total Earnings</label>
        <input type="number" id="edit-total-earnings">

        <label for="edit-fuel-cost">Fuel Cost</label>
        <input type="number" id="edit-fuel-cost">

        <label for="edit-maintenance-cost">Maintenance Cost</label>
        <input type="number" id="edit-maintenance-cost">

        <label for="edit-supplies-cost">Supplies Cost</label>
        <input type="number" id="edit-supplies-cost">

        <label for="edit-total-mileage">Total Mileage</label>
        <input type="number" id="edit-total-mileage">

        <label for="edit-total-time">Total Drive Time</label>
        <input type="text" id="edit-total-time" placeholder="e.g., 1 hour 30 minutes">

        <label for="edit-hours-worked">Hours Worked (Optional)</label>
        <input type="number" id="edit-hours-worked">f

        <button type="button" class="save-btn" onclick="saveEditedLogEntry()">Save</button>
        <button type="button" class="cancel-btn" onclick="closeEditForm()">Cancel</button>
        <input type="hidden" id="edit-index">
    </div>

    <script>
        // Replace with your actual Google Maps API key
        const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';
        document.querySelector('script[src*="maps.googleapis.com"]').src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places&callback=initMap`;

        let map;
        let directionsService;
        let directionsRenderer;
        let autocompleteStart, autocompleteEnd;
        let logEntries = loadLog();
        let editingIndex = -1;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10,
                center: { lat: 37.7749, lng: -122.4194 },
                mapTypeControl: false,
                streetViewControl: false
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false
            });

            autocompleteStart = new google.maps.places.Autocomplete(document.getElementById("start-address"), { types: ['geocode'] });
            autocompleteEnd = new google.maps.places.Autocomplete(document.getElementById("end-address"), { types: ['geocode'] });

            autocompleteStart.addListener("place_changed", function () {
                const place = autocompleteStart.getPlace();
                if (place.geometry) {
                    document.getElementById("end-address").value = document.getElementById("start-address").value;
                } else {
                    document.getElementById("start-address").value = "";
                }
            });

            const savedMpg = localStorage.getItem('mpg');
            const savedGasPrice = localStorage.getItem('gasPrice');
            if (savedMpg) document.getElementById('mpg').value = savedMpg;
            if (savedGasPrice) document.getElementById('gas-price').value = savedGasPrice;

            document.querySelectorAll('input[id^="destination-"]').forEach(initAutocompleteDestination);
            displayLog();
            populateDayOptions();
        }

        function initAutocompleteDestination(inputElement) {
            const autocomplete = new google.maps.places.Autocomplete(inputElement, { types:['geocode'] });
        }

        async function calculateAndLog() {
            const calculationResult = await calculateRoute();
            if (calculationResult) {
                logEntry(calculationResult);
                displayLog();
                populateDayOptions();
            }
        }

        async function calculateRoute() {
            const startAddress = document.getElementById('start-address').value;
            const endAddress = document.getElementById('end-address').value;
            const mpg = parseFloat(document.getElementById('mpg').value);
            const gasPrice = parseFloat(document.getElementById('gas-price').value);
            const hoursWorked = parseFloat(document.getElementById('hours-worked').value) || 0;
            const maintenanceCost = parseFloat(document.getElementById('maintenance-cost').value) || 0;
            const suppliesCost = parseFloat(document.getElementById('supplies-cost').value) || 0;

            localStorage.setItem('mpg', mpg);
            localStorage.setItem('gasPrice', gasPrice);

            const destInputs = document.querySelectorAll('input[id^="destination-"]');
            const earningsInputs = document.querySelectorAll('input[id^="earnings-"]');
            const destinations = Array.from(destInputs).map(input => ({ location: input.value, stopover: true }));
            const earnings = Array.from(earningsInputs).map(input => parseFloat(input.value));
            const totalEarnings = earnings.reduce((sum, val) => sum + val, 0);

            const waypoints = destinations;

            const request = {
                origin: startAddress,
                destination: endAddress,
                waypoints: waypoints,
                travelMode: 'DRIVING'
            };

            return new Promise((resolve, reject) => {
                directionsService.route(request, (response, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(response);
                        document.getElementById('map').classList.remove('hidden');

                        let totalMileage = 0;
                        let totalDuration = 0;

                        response.routes[0].legs.forEach(leg => {
                            totalMileage += leg.distance.value / 1609.34;
                            totalDuration += leg.duration.value;
                        });

                        const fuelCost = (totalMileage / mpg) * gasPrice;
                        const netProfitBeforeOptional = totalEarnings - fuelCost;
                        const netProfit = netProfitBeforeOptional - maintenanceCost - suppliesCost;
                        const totalHoursSpent = hoursWorked + (totalDuration / 3600);
                        const profitPerHour = totalHoursSpent > 0 ? netProfit / totalHoursSpent : 0;

                        document.getElementById('total-mileage').textContent = totalMileage.toFixed(2);
                        document.getElementById('total-time').textContent = formatDuration(totalDuration);
                        document.getElementById('total-earnings').textContent = totalEarnings.toFixed(2);
                        document.getElementById('fuel-cost').textContent = fuelCost.toFixed(2);
                        document.getElementById('maintenance-cost-result').textContent = maintenanceCost.toFixed(2);
                        document.getElementById('supplies-cost-result').textContent = suppliesCost.toFixed(2);
                        document.getElementById('net-profit').textContent = netProfit.toFixed(2);
                        document.getElementById('profit-per-hour').textContent = profitPerHour.toFixed(2);
                        document.getElementById('results').classList.remove('hidden');

                        resolve({
                            date: new Date().toLocaleDateString(),
                            startTime: startAddress,
                            endTime: endAddress,
                            destinations: destinations.map(d => d.location),
                            earnings: earnings,
                            totalMileage: totalMileage.toFixed(2),
                            totalTime: formatDuration(totalDuration),
                            totalEarnings: totalEarnings.toFixed(2),
                            fuelCost: fuelCost.toFixed(2),
                            maintenanceCost: maintenanceCost.toFixed(2),
                            suppliesCost: suppliesCost.toFixed(2),
                            netProfit: netProfit.toFixed(2),
                            profitPerHour: profitPerHour.toFixed(2)
                        });

                    } else {
                        alert('Directions request failed due to ' + status);
                        document.getElementById('map').classList.add('hidden');
                        document.getElementById('results').classList.add('hidden');
                        resolve(null);
                    }
                });
            });
        }

function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            let formattedString = '';
            if (hours > 0) {
                formattedString += `${hours} hour${hours > 1 ? 's' : ''} `;
            }
            if (minutes > 0) {
                formattedString += `${minutes} minute${minutes > 1 ? 's' : ''} `;
            }
            if (hours === 0 && minutes === 0) {
                formattedString += `${remainingSeconds} second${remainingSeconds !== 1 ? 's' : ''}`;
            }
            return formattedString.trim();
        }

        function addDestination() {
            const newDestinationIndex = document.querySelectorAll('#destinations-container .destination').length + 1;
            const container = document.getElementById('destinations-container');
            const newDestinationDiv = document.createElement('div');
            newDestinationDiv.classList.add('destination');
            newDestinationDiv.innerHTML = `
                <label for="destination-${newDestinationIndex}">Destination <span class="math-inline">\{newDestinationIndex\}</label\>
<input type\="text" id\="destination\-</span>{newDestinationIndex}" placeholder="Enter destination address" required>
                <label for="earnings-${newDestinationIndex}">Earnings for Destination <span class="math-inline">\{newDestinationIndex\}</label\>
<input type\="number" id\="earnings\-</span>{newDestinationIndex}" placeholder="Enter earnings for destination" required>
                <div class="destination-actions">
                    <button class="delete-btn" onclick="deleteDestination(this)">Delete</button>
                    <button class="move-btn" onclick="moveDestinationUp(this)">Move Up</button>
                    <button class="move-btn" onclick="moveDestinationDown(this)">Move Down</button>
                </div>
            `;
            container.appendChild(newDestinationDiv);
            initAutocompleteDestination(newDestinationDiv.querySelector('input[type="text"]'));
        }

        function deleteDestination(button) {
            button.closest('.destination').remove();
        }

        function moveDestinationUp(button) {
            const destinationDiv = button.closest('.destination');
            const prevDiv = destinationDiv.previousElementSibling;
            if (prevDiv) {
                destinationDiv.parentNode.insertBefore(destinationDiv, prevDiv);
            }
        }

        function moveDestinationDown(button) {
            const destinationDiv = button.closest('.destination');
            const nextDiv = destinationDiv.nextElementSibling;
            if (nextDiv) {
                destinationDiv.parentNode.insertBefore(nextDiv, destinationDiv.nextSibling);
            }
        }

        function logEntry(data) {
            logEntries.push(data);
            saveLog();
        }

        function saveLog() {
            localStorage.setItem('routeLog', JSON.stringify(logEntries));
        }

        function loadLog() {
            const storedLog = localStorage.getItem('routeLog');
            return storedLog ? JSON.parse(storedLog) : [];
        }

function displayLog(filterDay = 'all') {
    const logList = document.getElementById('log-list');
    const organizedLog = organizeLogByDay();
    logList.innerHTML = '';

    for (const day in organizedLog) {
        if (filterDay === 'all' || filterDay === day) {
            const dayHeading = document.createElement('h3');
            dayHeading.textContent = day;
            logList.appendChild(dayHeading);

            for (let i = organizedLog[day].length - 1; i >= 0; i--) {
                const entry = organizedLog[day][i];
                const index = logEntries.findIndex(e => JSON.stringify(e) === JSON.stringify(entry));
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div class="log-item-details">
                        <strong>Date:</strong> ${entry.date}<br>
                        <strong>Start:</strong> ${entry.startTime}<br>
                        <strong>Destinations:</strong> ${entry.destinations.join(', ')}<br>
                        <strong>End:</strong> ${entry.endTime}<br>
                        <strong>Earnings:</strong> $${entry.totalEarnings}<br>
                        <strong>Fuel Cost:</strong> $${entry.fuelCost}<br>
                        <strong>Maintenance:</strong> $${entry.maintenanceCost}<br>
                        <strong>Supplies:</strong> $${entry.suppliesCost}<br>
                        <strong>Net Profit:</strong> $${entry.netProfit}
                    </div>
                    <div class="log-actions">
                        <button class="edit-btn" onclick="openEditForm(${index})">Edit</button>
                        <button onclick="viewLogEntry(${index})">View Details</button>
                        <button onclick="deleteLogEntry(${index})">Delete</button>
                    </div>
                `;
                logList.appendChild(listItem);
            }
        }
    }

    if (logList.innerHTML === '') {
        const emptyMessage = document.createElement('li');
        emptyMessage.textContent = filterDay === 'all' ? 'No log entries yet.' : `No entries for ${filterDay}.`;
        logList.appendChild(emptyMessage);
    }
}

        function viewLogEntry(index) {
            const entry = logEntries[index];
            alert(`
                Date: ${entry.date}
                Start Address: ${entry.startTime}
                Destinations: ${entry.destinations.join('\n - ')}
                End Address: ${entry.endTime}
                Earnings per Stop: $${entry.earnings.join(', $')}
                Total Mileage: ${entry.totalMileage} miles
                Total Drive Time: ${entry.totalTime}
                Total Earnings: $${entry.totalEarnings}
                Fuel Cost: $${entry.fuelCost}
                Maintenance Cost: $${entry.maintenanceCost}
                Supplies Cost: $${entry.suppliesCost}
                Net Profit: $${entry.netProfit}
                Profit per Hour: $${entry.profitPerHour}
            `);
        }

        function deleteLogEntry(index) {
            if (confirm('Are you sure you want to delete this log entry?')) {
                logEntries.splice(index, 1);
                saveLog();
                displayLog(document.getElementById('organize-by-day').value);
                populateDayOptions();
            }
        }

        function organizeLogByDay() {
            return logEntries.reduce((acc, entry) => {
                if (!acc[entry.date]) {
                    acc[entry.date] = [];
                }
                acc[entry.date].push(entry);
                return acc;
            }, {});
        }

        function populateDayOptions() {
            const organizeByDaySelect = document.getElementById('organize-by-day');
            const currentFilter = organizeByDaySelect.value;
            const days = Object.keys(organizeLogByDay());
            organizeByDaySelect.innerHTML = '<option value="all">All</option>';
            days.forEach(day => {
                const option = document.createElement('option');
                option.value = day;
                option.textContent = day;
                organizeByDaySelect.appendChild(option);
            });
            organizeByDaySelect.value = currentFilter; // Restore the previous filter
        }

function openEditForm(index) {
    console.log("openEditForm called with index:", index);
    editingIndex = index;
    const entry = logEntries[index];
    console.log("Log entry to edit:", entry);

    if (entry) {
        document.getElementById('edit-index').value = String(index);
        document.getElementById('edit-date').value = String(entry.date);
        document.getElementById('edit-start-address').value = String(entry.startTime);
        document.getElementById('edit-end-address').value = String(entry.endTime);
        document.getElementById('edit-total-earnings').value = String(entry.totalEarnings);
        document.getElementById('edit-fuel-cost').value = String(entry.fuelCost);
        document.getElementById('edit-maintenance-cost').value = String(entry.maintenanceCost);
        document.getElementById('edit-supplies-cost').value = String(entry.suppliesCost);
        document.getElementById('edit-total-mileage').value = String(entry.totalMileage);
        document.getElementById('edit-total-time').value = String(entry.totalTime);
        document.getElementById('edit-hours-worked').value = entry.hoursWorked || '';

        const editDestinationsContainer = document.getElementById('edit-destinations-container');
        editDestinationsContainer.innerHTML = '';
        entry.destinations.forEach((dest, i) => {
            const destDiv = document.createElement('div');
            destDiv.classList.add('destination');
            destDiv.innerHTML = `
                <label for="edit-destination-${i + 1}">Destination ${i + 1}</label>
                <input type="text" id="edit-destination-${i + 1}" value="${String(dest)}">
                <label for="edit-earnings-${i + 1}">Earnings ${i + 1}</label>
                <input type="number" id="edit-earnings-${i + 1}" value="${String(entry.earnings[i] || 0)}">
                <button type="button" class="delete-btn" onclick="deleteEditDestination(this)">Delete</button>
            `;
            editDestinationsContainer.appendChild(destDiv);
        });

document.getElementById('edit-form-container').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
    } else {
        console.error("Error: No log entry found at index:", index);
    }
}

function closeEditForm() {
    console.log("closeEditForm function called");
    document.getElementById('edit-form-container').style.display = 'none';
    document.getElementById('overlay').style.display = 'none';
    editingIndex = -1;
}

        function addEditDestination() {
            const container = document.getElementById('edit-destinations-container');
            const newIndex = container.querySelectorAll('.destination').length + 1;
            const newDestDiv = document.createElement('div');
            newDestDiv.classList.add('destination');
            newDestDiv.innerHTML = `
                <label for="edit-destination-${newIndex}">Destination <span class="math-inline">\{newIndex\}</label\>
<input type\="text" id\="edit\-destination\-</span>{newIndex}">
                <label for="edit-earnings-${newIndex}">Earnings <span class="math-inline">\{newIndex\}</label\>
<input type\="number" id\="edit\-earnings\-</span>{newIndex}" value="0">
                <button type="button" class="delete-btn" onclick="deleteEditDestination(this)">Delete</button>
            `;
            container.appendChild(newDestDiv);
        }

        function deleteEditDestination(button) {
            button.closest('.destination').remove();
        }

function saveEditedLogEntry() {
    console.log("saveEditedLogEntry function called");
    if (editingIndex === -1) {
        console.log("editingIndex is -1, no entry to save.");
        return;
    }

    const entry = logEntries[editingIndex];
    entry.date = document.getElementById('edit-date').value;
    entry.startTime = document.getElementById('edit-start-address').value;
    entry.endTime = document.getElementById('edit-end-address').value;
    entry.totalEarnings = parseFloat(document.getElementById('edit-total-earnings').value);
    entry.fuelCost = parseFloat(document.getElementById('edit-fuel-cost').value);
    entry.maintenanceCost = parseFloat(document.getElementById('edit-maintenance-cost').value);
    entry.suppliesCost = parseFloat(document.getElementById('edit-supplies-cost').value);
    entry.totalMileage = parseFloat(document.getElementById('edit-total-mileage').value);
    entry.totalTime = document.getElementById('edit-total-time').value;
    entry.hoursWorked = parseFloat(document.getElementById('edit-hours-worked').value) || 0; // Get hours worked

    // Recalculate net profit
    const netProfitBeforeOptional = entry.totalEarnings - entry.fuelCost;
    entry.netProfit = (netProfitBeforeOptional - entry.maintenanceCost - entry.suppliesCost).toFixed(2);

    // Calculate total hours spent
    let driveTimeInHours = 0;
    const timeMatch = entry.totalTime.match(/(\d+)\s*hour(s)?\s*(\d+)?\s*minute(s)?/i);
    if (timeMatch) {
        const hours = parseInt(timeMatch[1]) || 0;
        const minutes = parseInt(timeMatch[3]) || 0;
        driveTimeInHours = hours + (minutes / 60);
    } else {
        driveTimeInHours = parseFloat(entry.totalTime) || 0; // Try to parse as simple hours
    }

    const totalHoursSpent = entry.hoursWorked + driveTimeInHours;

    entry.profitPerHour = totalHoursSpent > 0 ? (parseFloat(entry.netProfit) / totalHoursSpent).toFixed(2) : '0.00';

    saveLog();
    displayLog(document.getElementById('organize-by-day').value);
    closeEditForm();
}

function exportToCSV() {
    const header = "Date,Start Address,Destinations,End Address,Total Earnings,Fuel Cost,Maintenance Cost,Supplies Cost,Net Profit,Total Mileage,Total Drive Time,Earnings per Stop,Profit per Hour\n";
    const csvRows = logEntries.map(entry => {
        // Explicitly format the date toYYYY-MM-DD
        const dateParts = entry.date.split('/'); // Adjust if your browser's default is different
        const formattedDate = `<span class="math-inline">\{dateParts\[2\]\}\-</span>{dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;

        const destinationsString = `"${entry.destinations.map(d => d.replace(/"/g, '""')).join(';')}"`;
        const earningsString = `"${entry.earnings.join(';')}"`;
        const totalTimeString = `"${entry.totalTime.replace(/"/g, '""')}"`;
        const startAddressString = `"${entry.startTime.replace(/"/g, '""')}"`;
        const endAddressString = `"${entry.endTime.replace(/"/g, '""')}"`;
        const profitPerHourString = entry.profitPerHour ? `"${entry.profitPerHour}"` : ""; // Handle potential undefined

        return [
            formattedDate,
            startAddressString,
            destinationsString,
            endAddressString,
            entry.totalEarnings,
            entry.fuelCost,
            entry.maintenanceCost,
            entry.suppliesCost,
            entry.netProfit,
            entry.totalMileage,
            totalTimeString,
            earningsString,
            profitPerHourString
        ].join(',');
    });
    const csvString = header + csvRows.join('\n');

    const filename = 'profit_log.csv';
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        window.open('data:text/csv;charset=utf-8,' + encodeURIComponent(csvString));
    }
}

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();

            const columns = ["Date", "Start", "Destinations", "End", "Earnings", "Fuel", "Maintenance", "Supplies", "Net Profit", "Mileage", "Drive Time"];
            const data = logEntries.map(entry => [
                entry.date,
                entry.startTime,
                entry.destinations.join('\n'),
                entry.endTime,
                `$${entry.totalEarnings}`,
                `$${entry.fuelCost}`,
                `$${entry.maintenanceCost}`,
                `$${entry.suppliesCost}`,
                `$${entry.netProfit}`,
                `${entry.totalMileage} mi`,
                entry.totalTime
            ]);

            pdf.autoTable({
                head: [columns],
                body: data,
                margin: { top: 20, left: 10, right: 10, bottom: 20 },
                headStyles: { fillColor: [44, 62, 80], textColor: [255, 255, 255] },
                columnStyles: { 2: { columnWidth: 30 } }, // Adjust column width for destinations
                didDrawPage: function(data) {
                    pdf.setFontSize(12);
                    pdf.setTextColor(40);
                    pdf.text(`Profit Log - Page ${data.pageNumber}`, data.settings.margin.left, pdf.internal.pageSize.height - 10);
                }
            });

            pdf.save('profit_log.pdf');
        }

function importLog() {
    const fileInput = document.getElementById('import-file');
    const file = fileInput.files[0];

    if (file) {
        const reader = new FileReader();

        reader.onload = function(e) {
            const csvData = e.target.result;
            const lines = csvData.split('\n').slice(1); // Skip the header row
            const newLogEntries = [];

            lines.forEach(line => {
                if (line) {
                    const values = line.match(/("([^"]*)"|[^,]+)/g);
                    console.log("CSV Line Values (Regex Split):", values);

                    if (values && values.length === 13) { // Expecting 13 columns now
                        try {
                            const startTime = values[1].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const endTime = values[3].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const destinationsString = values[2];
                            const earningsString = values[11];
                            const totalTimeString = values[10].replace(/^"|"$/g, '').replace(/""/g, '"');
                            const profitPerHourString = values[12].replace(/^"|"$/g, '');
                            const profitPerHour = parseFloat(profitPerHourString) || 0; // Parse or default to 0

                            const destinations = destinationsString.startsWith('"') && destinationsString.endsWith('"')
                                ? destinationsString.slice(1, -1).split(';').map(d => d.replace(/""/g, '"'))
                                : [destinationsString.replace(/^"|"$/g, '')]; // Clean up single destination

                            const earnings = earningsString.startsWith('"') && earningsString.endsWith('"')
                                ? earningsString.slice(1, -1).split(';').map(parseFloat)
                                : [parseFloat(earningsString.replace(/^"|"$/g, ''))]; // Clean up single earning

                            newLogEntries.push({
                                date: values[0],
                                startTime: startTime,
                                destinations: destinations,
                                endTime: endTime,
                                totalEarnings: parseFloat(values[4]),
                                fuelCost: parseFloat(values[5]),
                                maintenanceCost: parseFloat(values[6]),
                                suppliesCost: parseFloat(values[7]),
                                netProfit: parseFloat(values[8]),
                                totalMileage: parseFloat(values[9]),
                                totalTime: totalTimeString.replace(/:/g, ' hours ').replace(/:/g, ' minutes ').replace(/ seconds$/, '').trim(),
                                earnings: earnings,
                                profitPerHour: profitPerHour
                            });
                        } catch (error) {
                            console.error("Error parsing CSV line:", line, error);
                        }
                    } else {
                        console.warn("Skipping invalid CSV line (wrong number of columns):", line, values ? values.length : 0);
                    }
                }
            });

            logEntries = [...logEntries, ...newLogEntries];
            saveLog();
            displayLog(document.getElementById('organize-by-day').value);
            populateDayOptions();
            alert('Log imported successfully!');
        };

        reader.onerror = function() {
            alert('Error reading the file.');
        };

        reader.readAsText(file);
    } else {
        alert('Please select a CSV file to import.');
    }
}
    </script>

