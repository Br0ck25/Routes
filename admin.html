<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Admin Panel - Go Route Yourself</title>

    <!-- Load configuration file -->
    <script src="/config.js"></script>

    <!-- Load security utilities -->
    <script src="/utils.js"></script>

    <style>
      #log-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        width: 90%;
        max-width: 600px;
        max-height: 80%;
        transform: translate(-50%, -50%);
        background: white;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        overflow-y: auto;
        padding: 20px;
        display: none;
        z-index: 9999;
      }
      #log-modal h2 {
        margin-top: 0;
      }
      .log-entry {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }
      .log-entry p {
        margin: 4px 0;
        font-size: 14px;
      }
      #log-close {
        background: #dc3545;
        color: white;
        border: none;
        float: right;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
      }

      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f4f6f9;
      }
      h1 {
        color: #333;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        background: white;
        margin-bottom: 30px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 10px;
        text-align: left;
        font-size: 14px;
      }
      th {
        background: #007bff;
        color: white;
      }
      button {
        padding: 6px 10px;
        font-size: 13px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .danger {
        background-color: #dc3545;
        color: white;
      }
      .reset {
        background-color: #17a2b8;
        color: white;
      }
      .token {
        background-color: #ffc107;
        color: black;
      }
      .disable {
        background-color: #6c757d;
        color: white;
      }
      .view {
        background-color: #28a745;
        color: white;
      }
      .fix-btn {
        background-color: #28a745;
        color: white;
        margin-top: 10px;
      }
      code {
        background: #f0f0f0;
        padding: 2px 5px;
        border-radius: 4px;
      }
      .user-block {
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      }
    </style>
  </head>
  <body>
    <h1>üîê Admin Panel ‚Äî Registered Users</h1>
    <table id="user-table">
      <tr>
        <th>Username</th>
        <th>Reset Key</th>
        <th>Created At</th>
        <th>Method</th>
        <th>Logs</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </table>

    <h2>üß© Fix Corrupted Users</h2>
    <div id="corrupted-users">Loading corrupted users...</div>

    <script>
      // Load admin token from config
      // SECURITY WARNING: This is still not secure! Implement proper authentication!
      const adminToken = CONFIG.ADMIN_TOKEN;

      // Use security utilities from utils.js
      const { escapeHtml, sanitizeString } = window.SecurityUtils;

      async function loadUsers() {
        const res = await fetch(
          "https://logs.gorouteyourself.com/admin/users",
          {
            headers: { Authorization: adminToken },
          }
        );
        const users = await res.json();
        const table = document.getElementById("user-table");

        users.forEach((user) => {
          const tr = document.createElement("tr");
          // Escape user data to prevent XSS attacks
          const safeUsername = escapeHtml(user.username);
          const safeResetKey = escapeHtml(user.resetKey);
          const safeCreatedAt = escapeHtml(user.createdAt || "");
          const safeMethod = escapeHtml(user.method);
          const safeToken = escapeHtml(user.token);

          tr.innerHTML = `
        <td>${safeUsername}</td>
        <td><code>${safeResetKey}</code></td>
        <td>${safeCreatedAt}</td>
        <td>${safeMethod}</td>
        <td>${user.logCount}</td>
        <td>${user.disabled ? "‚ùå Disabled" : "‚úÖ Active"}</td>
        <td>
          <button class="reset" onclick="resetUserPassword('${safeUsername}')">Reset Password</button>
          <button class="reset" onclick="adminAction('reset-key','${safeUsername}')">New Reset Key</button>
          <button class="token" onclick="adminAction('reset-token','${safeUsername}')">New Token</button>
          <button class="disable" onclick="adminAction('toggle-disabled','${safeUsername}')">${user.disabled ? "Enable" : "Disable"}</button>
          <button class="danger" onclick="adminAction('delete','${safeUsername}')">Delete</button>
          <button class="view" onclick="viewLog('${safeToken}')">View Log</button>
        </td>
      `;
          table.appendChild(tr);
        });
      }

      async function adminAction(action, username) {
        const ok = confirm(
          `Are you sure you want to '${action}' for '${username}'?`
        );
        if (!ok) return;

        const payload = { action, username };

        const res = await fetch(
          "https://logs.gorouteyourself.com/admin/actions",
          {
            method: "POST",
            headers: {
              Authorization: adminToken,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(payload),
          }
        );

        const contentType = res.headers.get("content-type") || "";

        if (contentType.includes("application/json")) {
          const result = await res.json();
          if (result.status === "updated") {
            const user = result.user;
            alert(
              `‚úÖ Action completed for ${user.username}\n\nNew Token:\n${user.token}\nReset Key:\n${user.resetKey}`
            );
          } else if (result.status === "deleted") {
            alert(`üóëÔ∏è User '${username}' deleted.`);
          } else {
            alert("Something went wrong: " + JSON.stringify(result));
          }
        } else {
          const message = await res.text();
          alert("Unexpected response:\n" + message);
        }

        location.reload();
      }

      async function viewLog(token) {
        const res = await fetch("https://logs.gorouteyourself.com/logs", {
          headers: { Authorization: "Bearer " + token },
        });

        const modal = document.getElementById("log-modal");
        const content = document.getElementById("log-content");
        content.innerHTML = "";

        if (!res.ok) {
          content.innerHTML = `<p style="color: red;">‚ùå Failed to load logs.</p>`;
          modal.style.display = "block";
          return;
        }

        const logs = await res.json();

        if (!Array.isArray(logs) || logs.length === 0) {
          content.innerHTML = `<p>‚ÑπÔ∏è No logs found for this user.</p>`;
          modal.style.display = "block";
          return;
        }

        logs.forEach((entry, i) => {
          const div = document.createElement("div");
          div.className = "log-entry";
          // Escape all user-provided data to prevent XSS
          const safeDate = escapeHtml(entry.date || "‚Äî");
          const safeStartTime = escapeHtml(entry.startTime || "‚Äî");
          const safeEndTime = escapeHtml(entry.endTime || "‚Äî");
          const safeDestinations = escapeHtml(entry.destinations?.join(", ") || "‚Äî");
          const safeEarnings = escapeHtml(entry.totalEarnings || "0.00");
          const safeNetProfit = escapeHtml(entry.netProfit || "0.00");
          const safeMileage = escapeHtml(entry.totalMileage || "‚Äî");
          const safeTime = escapeHtml(entry.totalTime || "‚Äî");
          const safeNotes = escapeHtml(entry.notes || "‚Äî");

          div.innerHTML = `
      <strong>üìå Log #${i + 1}</strong>
      <p><strong>Date:</strong> ${safeDate}</p>
      <p><strong>Start:</strong> ${safeStartTime}</p>
      <p><strong>End:</strong> ${safeEndTime}</p>
      <p><strong>Stops:</strong> ${safeDestinations}</p>
      <p><strong>Earnings:</strong> $${safeEarnings}</p>
      <p><strong>Net Profit:</strong> $${safeNetProfit}</p>
      <p><strong>Mileage:</strong> ${safeMileage} mi</p>
      <p><strong>Time:</strong> ${safeTime}</p>
      <p><strong>Notes:</strong> ${safeNotes}</p>
    `;
          content.appendChild(div);
        });

        modal.style.display = "block";
      }

      async function loadCorruptedUsers() {
        const res = await fetch(
          "https://logs.gorouteyourself.com/admin/fixable-users",
          {
            headers: { Authorization: adminToken },
          }
        );
        const list = await res.json();
        const container = document.getElementById("corrupted-users");
        container.innerHTML = "";

        if (list.length === 0) {
          container.textContent = "‚úÖ No corrupted users found.";
          return;
        }

        list.forEach((user) => {
          const div = document.createElement("div");
          div.className = "user-block";
          // Escape user data to prevent XSS
          const safeKey = escapeHtml(user.key);
          const safePassword = escapeHtml(user.password);
          const safeToken = escapeHtml(user.token || "(new will be generated)");

          div.innerHTML = `
        <div><strong>${safeKey}</strong></div>
        <div>Password: <code>${safePassword}</code></div>
        <div>Token: <code>${safeToken}</code></div>
        <button class="fix-btn" data-key="${safeKey}" data-password="${safePassword}" data-token="${safeToken}">‚úÖ Fix User</button>
      `;
          container.appendChild(div);
        });

        document.querySelectorAll(".fix-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const key = btn.dataset.key;
            const password = btn.dataset.password;
            const token = btn.dataset.token || crypto.randomUUID();
            const resetKey = crypto.randomUUID();

            const resp = await fetch(
              "https://logs.gorouteyourself.com/admin/fix-user",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: adminToken,
                },
                body: JSON.stringify({ key, password, token, resetKey }),
              }
            );

            alert(await resp.text());
            location.reload();
          });
        });
      }
      async function resetUserPassword(username) {
        const newPassword = prompt(`Enter a new password for ${username}`);
        if (!newPassword) return;

        const res = await fetch(
          "https://logs.gorouteyourself.com/admin/actions",
          {
            method: "POST",
            headers: {
              Authorization: adminToken,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              action: "reset-password",
              username,
              newPassword,
            }),
          }
        );

        const result = await res.json().catch(() => null);
        if (result?.status === "updated") {
          alert(`‚úÖ Password reset for ${username}`);
        } else {
          alert("‚ùå Failed to reset password.");
        }
      }

      loadUsers();
      loadCorruptedUsers();
    </script>

    <div id="log-modal">
      <button
        id="log-close"
        onclick="document.getElementById('log-modal').style.display='none'"
      >
        Close
      </button>
      <h2>üìù User Logs</h2>
      <div id="log-content"></div>
    </div>
  </body>
</html>
